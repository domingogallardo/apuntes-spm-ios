



<!DOCTYPE html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copiar al portapapeles">
      
        <meta name="lang:clipboard.copied" content="Copiado al portapapeles">
      
        <meta name="lang:search.language" content="es">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No se encontraron documentos">
      
        <meta name="lang:search.result.one" content="1 documento encontrado">
      
        <meta name="lang:search.result.other" content="# documentos encontrados">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.4">
    
    
      
        <title>Sesion03 icloud - SPM-iOS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../#sesion-3-icloud-y-cloudkit" tabindex="1" class="md-skip">
        Saltar a contenido
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="SPM-iOS" class="md-header-nav__button md-logo">
          
            <img src="../imagenes/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                SPM-iOS
              </span>
              <span class="md-header-nav__topic">
                Sesion03 icloud
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Teclee para comenzar búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="SPM-iOS" class="md-nav__button md-logo">
      
        <img src="../imagenes/logo.png" width="48" height="48">
      
    </a>
    SPM-iOS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../sesion00/sesion00-introduccion.html" title="Introducción" class="md-nav__link">
      Introducción
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../sesion01/sesion01-firma-aprovisionamiento.html" title="Firma, aprovisionamiento y distribución de apps" class="md-nav__link">
      Firma, aprovisionamiento y distribución de apps
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#icloud" title="iCloud" class="md-nav__link">
    iCloud
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filosofia-de-icloud-para-el-usuario-de-ios" title="Filosofía de iCloud (para el usuario de iOS)" class="md-nav__link">
    Filosofía de iCloud (para el usuario de iOS)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cuenta-icloud" title="Cuenta iCloud" class="md-nav__link">
    Cuenta iCloud
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#distintas-apis" title="Distintas APIs" class="md-nav__link">
    Distintas APIs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparacion-de-aprovisionamiento-y-permisos-para-icloud" title="Preparación de aprovisionamiento y permisos para iCloud" class="md-nav__link">
    Preparación de aprovisionamiento y permisos para iCloud
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creacion-del-app-id" title="Creación del App ID" class="md-nav__link">
    Creación del App ID
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#confirmacion-del-app-id" title="Confirmación del App ID" class="md-nav__link">
    Confirmación del App ID
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-de-almacenamiento-clave-valor" title="API de almacenamiento clave-valor" class="md-nav__link">
    API de almacenamiento clave-valor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#metodo-synchronize" title="Método synchronize" class="md-nav__link">
    Método synchronize
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ejemplo-de-uso-de-synchronize-al-lanzar-la-app" title="Ejemplo de uso de synchronize al lanzar la app" class="md-nav__link">
    Ejemplo de uso de synchronize al lanzar la app
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#guardar-valores-en-el-almacen-de-claves-valor" title="Guardar valores en el almacén de claves-valor" class="md-nav__link">
    Guardar valores en el almacén de claves-valor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#obtencion-de-valores-del-almacen-de-claves-valor" title="Obtención de valores del almacén de claves-valor" class="md-nav__link">
    Obtención de valores del almacén de claves-valor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#definiendo-un-observador-de-cambios" title="Definiendo un observador de cambios" class="md-nav__link">
    Definiendo un observador de cambios
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ejemplo-de-definicion-de-un-observador-de-la-notificacion" title="Ejemplo de definición de un observador de la notificación" class="md-nav__link">
    Ejemplo de definición de un observador de la notificación
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practica-todolist-con-icloud-clave-valor-2" title="Práctica: ToDoList con iCloud clave-valor (2)" class="md-nav__link">
    Práctica: ToDoList con iCloud clave-valor (2)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cloudkit" title="CloudKit" class="md-nav__link">
    CloudKit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduccion-a-cloudkit" title="Introducción a CloudKit" class="md-nav__link">
    Introducción a CloudKit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cloudkit-trabaja-sobre-registros-en-icloud" title="CloudKit trabaja sobre registros en iCloud" class="md-nav__link">
    CloudKit trabaja sobre registros en iCloud
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#registros-publicos-y-privados" title="Registros públicos y privados" class="md-nav__link">
    Registros públicos y privados
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tecnologia-de-transporte" title="Tecnología de transporte" class="md-nav__link">
    Tecnología de transporte
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elementos-de-cloudkit" title="Elementos de CloudKit" class="md-nav__link">
    Elementos de CloudKit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#contenedores" title="Contenedores" class="md-nav__link">
    Contenedores
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gestion-en-el-member-center" title="Gestión en el member center" class="md-nav__link">
    Gestión en el member center
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asignacion-del-container-al-app-id" title="Asignación del container al App ID" class="md-nav__link">
    Asignación del container al App ID
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creacion-del-perfil-de-aprovisionamiento" title="Creación del perfil de aprovisionamiento" class="md-nav__link">
    Creación del perfil de aprovisionamiento
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actualizacion-de-capacidades-de-la-app-todolistcloudkit" title="Actualización de capacidades de la app ToDoListCloudKit" class="md-nav__link">
    Actualización de capacidades de la app ToDoListCloudKit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dashboard" title="Dashboard" class="md-nav__link">
    Dashboard
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dashboard-permisos" title="Dashboard: permisos" class="md-nav__link">
    Dashboard: permisos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dashboard-tipos-de-registros" title="Dashboard: tipos de registros" class="md-nav__link">
    Dashboard: tipos de registros
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dashboard-logs" title="Dashboard: logs" class="md-nav__link">
    Dashboard: logs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clase-ckcontainer" title="Clase CKContainer" class="md-nav__link">
    Clase CKContainer
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caracteristicas-sociales-de-cloudkit" title="Características sociales de CloudKit" class="md-nav__link">
    Características sociales de CloudKit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caracteristicas-sociales-de-cloudkit_1" title="Características sociales de CloudKit" class="md-nav__link">
    Características sociales de CloudKit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ejemplo-de-codigo-de-caracteristicas-sociales" title="Ejemplo de código de características sociales" class="md-nav__link">
    Ejemplo de código de características sociales
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bases-de-datos" title="Bases de datos" class="md-nav__link">
    Bases de datos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bases-de-datos_1" title="Bases de datos" class="md-nav__link">
    Bases de datos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bases-de-datos_2" title="Bases de datos" class="md-nav__link">
    Bases de datos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bases-de-datos_3" title="Bases de datos" class="md-nav__link">
    Bases de datos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#registros" title="Registros" class="md-nav__link">
    Registros
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creacion-de-registros" title="Creación de registros" class="md-nav__link">
    Creación de registros
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datos-en-los-registros" title="Datos en los registros" class="md-nav__link">
    Datos en los registros
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grabacion-de-registros" title="Grabación de registros" class="md-nav__link">
    Grabación de registros
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relaciones-entre-registros-referencias" title="Relaciones entre registros: referencias" class="md-nav__link">
    Relaciones entre registros: referencias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" title="Referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#queries" title="Queries" class="md-nav__link">
    Queries
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ejemplo" title="Ejemplo" class="md-nav__link">
    Ejemplo
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operaciones-con-registros-obtenidos" title="Operaciones con registros obtenidos" class="md-nav__link">
    Operaciones con registros obtenidos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#suscripciones" title="Suscripciones" class="md-nav__link">
    Suscripciones
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cloudkit-js" title="CloudKit JS" class="md-nav__link">
    CloudKit JS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practica-todolist-con-icloud-clave-valor-1" title="Práctica: ToDoList con iCloud clave-valor (1)" class="md-nav__link">
    Práctica: ToDoList con iCloud clave-valor (1)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practica-todolist-con-icloud-clave-valor-2_1" title="Práctica: ToDoList con iCloud clave-valor (2)" class="md-nav__link">
    Práctica: ToDoList con iCloud clave-valor (2)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practica-todolist-en-cloudkit" title="Práctica: ToDoList en CloudKit" class="md-nav__link">
    Práctica: ToDoList en CloudKit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pista-para-actualizar-la-tabla" title="Pista para actualizar la tabla" class="md-nav__link">
    Pista para actualizar la tabla
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias_1" title="Referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <!--
Referencias:
WWDC vídeo What's next in CoreData: https://developer.apple.com/videos/wwdc/2014/?id=225
WWDC vídeo Advanced CloudKit: https://developer.apple.com/videos/wwdc/2014/?id=231
WWDC vídeo Introducing CloudKit: https://developer.apple.com/videos/wwdc/2014/?id=208
iCloud Design Guide: https://developer.apple.com/library/ios/documentation/General/Conceptual/iCloudDesignGuide/Chapters/Introduction.html
CloudKit Quick Start: https://developer.apple.com/library/ios/documentation/DataManagement/Conceptual/CloudKitQuickStart/Introduction/Introduction.html#//apple_ref/doc/uid/TP40014987

Xamarin Tutorial CloudKit: http://developer.xamarin.com/guides/ios/platform_features/intro_to_cloudkit/
Ray Wenderlich Core Data Tutorial con Swift: http://www.raywenderlich.com/85578/first-core-data-app-using-swift


-->

<h1 id="sesion-3-icloud-y-cloudkit">Sesión 3: iCloud y CloudKit<a class="headerlink" href="#sesion-3-icloud-y-cloudkit" title="Permanent link">&para;</a></h1>
<h4>Servicios de las plataformas móviles - iOS</h4>
<p><small>Domingo Gallardo - domingo.gallardo@ua.es<br />
Departamento Ciencia de la Computación e Inteligencia Artificial<br />
Master Programación de Dispositivos Móviles <br />
2017-18</small> </p>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="icloud">iCloud<a class="headerlink" href="#icloud" title="Permanent link">&para;</a></h2>
<!-- .slide: class="image-right"-->

<p><img style="margin-left:20px" src="imagenes/iCloud_intro.png" width="400px"/></p>
<ul>
<li>iCloud es un servicio de Apple que permite a un usuario acceder a su
  contenido personal (datos, documentos) en todos sus dispositivos
  utilizando su Apple ID.</li>
<li>iCloud consigue esto combinando almacenamiento en la nube y APIs
  dedicadas integradas en el sistema operativo.</li>
<li>Apple proporciona la infraestructura de servidores, de transmisión
  de datos y de cuentas de usuario, facilitando el trabajo a los
  desarrolladores que no necesitan crear sus propios servicios ni
  recurrir a soluciones de terceros.</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="filosofia-de-icloud-para-el-usuario-de-ios">Filosofía de iCloud (para el usuario de iOS)<a class="headerlink" href="#filosofia-de-icloud-para-el-usuario-de-ios" title="Permanent link">&para;</a></h2>
<ul>
<li>La idea principal tras iCloud es eliminar la sincronización
  explícita entre dispositivos.</li>
<li>Un usuario nunca necesita pensar sobre la sincronización, y la app
  nunca interactúa directamente con los servidores de iCloud.</li>
<li>Para el usuario, los cambios aparecen automáticamente en todos los
  dispositivos conectados a la cuenta iCloud.</li>
<li>Para el desarrollador, depende del API de iCloud que se utilice
  estos cambios son más o menos automáticos.</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="cuenta-icloud">Cuenta iCloud<a class="headerlink" href="#cuenta-icloud" title="Permanent link">&para;</a></h2>
<!-- .slide: class="image-right"-->

<p><img style="margin-left:20px" src="imagenes/icloud-movil.png" width="250px"/></p>
<ul>
<li>Todo usuario de Apple puede activar una cuenta de iCloud usando su
  Apple ID</li>
<li>Permite identificarse y mantenerse logeado en el dispositivo</li>
<li>Puede activarse desde un Mac, desde un dispositivo iOS, desde la web
  o desde el simulador. Si es la primera vez que usas iCloud desde el
  simulador <strong>debes logearte con tu Apple Id en
  <a href="https://www.icloud.com">icloud.com</a> y aceptar los términos</strong>.</li>
<li>Permite mantener el estado en aplicaciones ejecutándose en distintos
  dispositivos: Recordatorios, Notas, ...</li>
<li>El sistema operativo encripta todos los datos antes de
  transmitirlos a los servidores de iCloud, los cuales almacenan los
  datos también en formato encriptado. Se utilizan tokens para la
  autenticación. </li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="distintas-apis">Distintas APIs<a class="headerlink" href="#distintas-apis" title="Permanent link">&para;</a></h2>
<ul>
<li>Almacenamiento <strong>clave-valor en iCloud</strong>: para mantener el estado de
  la aplicación (puntuación de un juego, última página leída, etc.).</li>
<li><strong>Documentos en iCloud</strong>: para gestionar documentos en la nube y
  mantenerlos sincronizados entre iPhone/iPad/Mac.</li>
<li><strong>iCloud con Core Data</strong>: para mantener de forma automática en
  iCloud una copia de todos los datos de la app gestionados con Core
  Data. Versión inicial con muchos problemas, muy mejorado en las
  últimas versiones.</li>
<li><strong>CloudKit</strong> (a partir de iOS 8): nueva tecnología a partir de iOS 8
  que permite mayor flexibilidad y control. Basado en registros con
  diccionarios clave-valor, enfoque muy similar a las tecnologías
  NoSQL.</li>
<li>API de transporte que no mantiene un estado local.</li>
<li>Basada en peticiones y respuestas asíncronas.</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="preparacion-de-aprovisionamiento-y-permisos-para-icloud">Preparación de aprovisionamiento y permisos para iCloud<a class="headerlink" href="#preparacion-de-aprovisionamiento-y-permisos-para-icloud" title="Permanent link">&para;</a></h2>
<ul>
<li>Para desarrollar con iCloud es necesario estar registrado como
  desarrollador en el programa de desarrollo de Apple. También puedes
  hacerlo con tu Apple ID registrado en el equipo de la UA.</li>
<li>Para usar los servicios de iCloud es necesario crear un perfil de
  aprovisionamiento con un App Id concreto, añadir el servicio de
  iCloud y activar el permiso (<em>capabilities</em>) en la app con XCode.</li>
<li>Si estás registrado en el equipo de desarrollo con un rol de
  administrador (o tienes una cuenta de pago en la que tienes todos
  los permisos de tu equipo), se puede hacer todo automaticamente
  desde XCode.</li>
<li>Puedes utilizar el perfil de aprovisionamiento <code>UA ToDoListCloudKit
  Profile</code> creado en el <em>member center</em> del equipo de la
  universidad. El <em>bundle ID</em> de la app debe ser
  <code>es.ua.mastermoviles.ToDoListCloudKit</code>. </li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="creacion-del-app-id">Creación del App ID<a class="headerlink" href="#creacion-del-app-id" title="Permanent link">&para;</a></h2>
<ul>
<li>Se debe crear el App ID que otorgue la capacidad de acceso a iCloud.</li>
<li>Creamos el permiso (App ID) <code>Master Moviles ToDoListCloudKit</code> que
  incluye la capacidad de iCloud.</li>
</ul>
<p><img src="imagenes/appid-icloud.png" width="470px"/> <img src="imagenes/appid-icloud-servicios.png" width="470px"/></p>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="confirmacion-del-app-id">Confirmación del App ID<a class="headerlink" href="#confirmacion-del-app-id" title="Permanent link">&para;</a></h2>
<ul>
<li>La activación del permiso de iCloud aparecerá en amarillo porque
  requiere una configuración posterior relacionada con CloudKit (lo
  veremos más adelante).</li>
</ul>
<p><img src="imagenes/confirmacion-app-id-cloudkit.png" width="400px"/></p>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="api-de-almacenamiento-clave-valor">API de almacenamiento clave-valor<a class="headerlink" href="#api-de-almacenamiento-clave-valor" title="Permanent link">&para;</a></h2>
<!-- .slide: class="image-right"-->

<p><img style="margin-left:20px" src="imagenes/kvs_intro.png" width="300px"/></p>
<ul>
<li>Permite guardar y recuperar en iCloud claves y valores desde los
  dispositivos en los que el usuario está registrado con su Apple Id.</li>
<li>Para acceder a los valores debemos usar la clase
  <a href="https://developer.apple.com/library/ios/documentation/Foundation/Reference/NSUbiquitousKeyValueStore_class/index.html">NSUbiquitousKeyValueStore</a>.</li>
<li>Puedes almacenar <code>String</code>s, valores escalares como <code>BOOL</code> o
  <code>Double</code>, diccionarios y también objetos de cualquiera de los
  siguientes tipos: <code>NSNumber</code>, <code>NSString</code>, <code>NSDate</code>, <code>NSData</code>,
  <code>NSArray</code>, or <code>NSDictionary</code>.</li>
<li>El espacio de almacenamiento total, para un usuario dado y una app,
  es de 1 MB y un máximo de 1024 claves.</li>
<li>Para obtener el objeto compartido iCloudKeyValueStore:</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">let</span> <span class="nv">iCloudStore</span> <span class="p">=</span> <span class="bp">NSUbiquitousKeyValueStore</span><span class="p">.</span><span class="k">default</span>
</pre></div>
</td></tr></table>

<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="metodo-synchronize">Método <code>synchronize</code><a class="headerlink" href="#metodo-synchronize" title="Permanent link">&para;</a></h2>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">synchronize</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">Bool</span>
</pre></div>
</td></tr></table>
- Devuelve <code>true</code> si las claves y valores en memoria y en disco están
  sincronizados o <code>false</code> si ha sucedido algún error. Por ejemplo,
  devuelve <code>false</code> si la app no se ha compilado con las peticiones
  adecuadas de <em>entitlement</em> o si el usuario no está logeado e iCloud.
- Los cambios al almacén de claves-valor se salvan en memoria. El
  sistema sincroniza automáticamente estos datos con la caché del
  disco en los momentos apropiados. Por ejemplo, cuando el app pasa a
  segundo plano o cuando se reciben cambios de iCloud.
- Este método no fuerza la subida a iCloud de los nuevos valores y
  claves, sino que hace saber a iCloud que los valores están listos
  para ser subidos. El sistema controla cuándo subir los datos.
- No es obligatorio su uso, pero es recomendable cuando estamos
  trabajando con el simulador para asegurarnos de que el almacén de
  claves-valor se guarda.
- Se recomiendo también hacerlo después de lanzar la app o cuando
  vuelve al primer plano.</p>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="ejemplo-de-uso-de-synchronize-al-lanzar-la-app">Ejemplo de uso de <code>synchronize</code> al lanzar la app<a class="headerlink" href="#ejemplo-de-uso-de-synchronize-al-lanzar-la-app" title="Permanent link">&para;</a></h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">:</span> <span class="bp">UIApplication</span><span class="p">,</span> <span class="n">didFinishLaunchingWithOptions</span> <span class="n">launchOptions</span><span class="p">:</span> <span class="p">[</span><span class="bp">NSObject</span><span class="p">:</span> <span class="nb">AnyObject</span><span class="p">]?)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">store</span> <span class="p">=</span> <span class="bp">NSUbiquitousKeyValueStore</span><span class="p">.</span><span class="k">default</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">synchronize</span><span class="p">())</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Sincronización OK&quot;</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Problemas en la sincronización&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="guardar-valores-en-el-almacen-de-claves-valor">Guardar valores en el almacén de claves-valor<a class="headerlink" href="#guardar-valores-en-el-almacen-de-claves-valor" title="Permanent link">&para;</a></h2>
<ul>
<li>Para actualizar los valores hay que usar los métodos <em>set</em>. El
  primer parámetro es el valor a guardar y el segundo la clave:<ul>
<li><code>set(Bool, forKey: String)</code></li>
<li><code>set(Double, forKey: String)</code></li>
<li><code>set(Int64, forKey: String)</code></li>
<li><code>set([Any]?, forKey: String)</code></li>
<li>...</li>
</ul>
</li>
<li>Por ejemplo,
  <a href="https://developer.apple.com/reference/foundation/nsubiquitouskeyvaluestore/1407812-set"><code>set(Int64, forKey: String)</code></a> actualiza en el almacén el valor long long (<code>Int64</code>) asociándolo a
  una clave especificada:</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">store</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nb">Int64</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">forKey</span><span class="p">:</span> <span class="s">&quot;puntuacion&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="obtencion-de-valores-del-almacen-de-claves-valor">Obtención de valores del almacén de claves-valor<a class="headerlink" href="#obtencion-de-valores-del-almacen-de-claves-valor" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p>Funciones que obtienen los distintos tipos de datos a partir de una
  clave (una cadena):</p>
<ul>
<li><code>array(forKey: String)</code></li>
<li><code>bool(forKey: String)</code></li>
<li><code>dictionary(forKey: String)</code></li>
<li><code>string(forKey: String)</code></li>
<li>...</li>
</ul>
</li>
<li>
<p>Por ejemplo,
  <a href="https://developer.apple.com/reference/foundation/nsubiquitouskeyvaluestore/1413240-longlong"><code>longlong(forKey: String)</code></a>
  devuelve el valor <code>Int64</code> asociado a una clave especificada:</p>
</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">let</span> <span class="nv">puntuacion</span> <span class="p">=</span> <span class="nb">Int</span><span class="p">(</span><span class="n">store</span><span class="p">.</span><span class="n">longLong</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span><span class="s">&quot;puntuacion&quot;</span><span class="p">))</span>
</pre></div>
</td></tr></table>

<ul>
<li>Parámetros y resultados del método:<ul>
<li><code>forKey</code>: un String que es la clave en el almacén de
  claves-valor.</li>
<li>Devuelve: el valor asociado a la clave o 0 si la clave no existe
  o no contiene un valor numérico</li>
</ul>
</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="definiendo-un-observador-de-cambios">Definiendo un observador de cambios<a class="headerlink" href="#definiendo-un-observador-de-cambios" title="Permanent link">&para;</a></h2>
<ul>
<li>Además de almacenar los valores podemos recibir notificaciones
  (<a href="https://developer.apple.com/reference/foundation/nsnotification"><code>NSNotification</code></a>
  gestionadas por el
  <a href="https://developer.apple.com/reference/foundation/notificationcenter"><code>NotificationCenter</code></a>)
  de cambio de los valores en otros dispositivos conectados a iCloud.</li>
<li>En el lanzamiento del app hay que registrarse para la notificación
  <code>NSUbiquitousKeyValueStoreDidChangeExternallyNotification</code>.</li>
<li>La notificación se envía cuando el valor de una o más claves han
  cambiado debido a datos que han llegado desde iCloud. La
  notificación no se envía cuando la propia app ha cambiado los
  valores.</li>
<li>El diccionario atributo <code>userInfo</code> de la notificación contiene la
  razón de la notificación, así como una lista de los valores
  cambiados.</li>
<li>El objeto en la notificación es el <code>NSUbiquitousKeyValueStore</code> cuyo
  contenido ha cambiado.</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="ejemplo-de-definicion-de-un-observador-de-la-notificacion">Ejemplo de definición de un observador de la notificación<a class="headerlink" href="#ejemplo-de-definicion-de-un-observador-de-la-notificacion" title="Permanent link">&para;</a></h2>
<ul>
<li>Registramos una clausura para la notificación con el nombre
  <code>NSUbiquitousKeyValueStore.didChangeExternallyNotification</code> en el
  momento de lanzar la app, y llamamos al método <code>synchronize()</code> para
  obtener las parejas de claves-valor más recientes.</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">:</span> <span class="bp">UIApplication</span><span class="p">,</span> 
                 <span class="n">didFinishLaunchingWithOptions</span> <span class="n">launchOptions</span><span class="p">:</span> <span class="p">[</span><span class="bp">NSObject</span><span class="p">:</span> <span class="nb">AnyObject</span><span class="p">]?)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span> <span class="p">{</span>
        <span class="n">NotificationCenter</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span>
            <span class="n">forName</span><span class="p">:</span> <span class="bp">NSUbiquitousKeyValueStore</span><span class="p">.</span><span class="n">didChangeExternallyNotification</span><span class="p">,</span>
            <span class="n">object</span><span class="p">:</span> <span class="bp">NSUbiquitousKeyValueStore</span><span class="p">.</span><span class="k">default</span><span class="p">(),</span>
            <span class="n">queue</span><span class="p">:</span> <span class="n">OperationQueue</span><span class="p">.</span><span class="n">main</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">(</span><span class="n">notification</span><span class="p">)</span> <span class="k">in</span>
                <span class="kd">let</span> <span class="nv">ubiquitousKeyValueStore</span> <span class="p">=</span>
                    <span class="n">notification</span><span class="p">.</span><span class="n">object</span> <span class="k">as</span><span class="p">!</span> <span class="bp">NSUbiquitousKeyValueStore</span>
                <span class="n">ubiquitousKeyValueStore</span><span class="p">.</span><span class="n">synchronize</span><span class="p">()</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="practica-todolist-con-icloud-clave-valor-2">Práctica: ToDoList con iCloud clave-valor (2)<a class="headerlink" href="#practica-todolist-con-icloud-clave-valor-2" title="Permanent link">&para;</a></h2>
<!-- .slide: class="image-right"-->

<p><img style="margin-left:20px" src="imagenes/to-do-list-alerta.png"
width="180px"/> </p>
<p><img style="margin-left:20px" src="imagenes/to-do-list.png"
width="180px"/></p>
<ul>
<li>Debes modificar la aplicación para que se guarden en el almacén clave-valor
  de iCloud del usuario:<ul>
<li>Número de tareas terminadas</li>
<li>Última tarea terminada</li>
<li>Debes usar la app en el simulador habiéndote logeado en iCloud en el
propio simulador.</li>
<li>Prueba a ejecutar distintas veces la app desde el simulador,
  incluso a eliminar la aplicación y volver a instalarla. Debería
  conservarse el número de tareas terminadas y el nombre de la
  última. Se borrarán las tareas pendientes (las guardaremos en
  CloudKit en la sesión siguiente).</li>
<li>Muestra los datos guardados con una
  <a href="https://developer.apple.com/reference/uikit/uialertcontroller">alerta</a>
  al arrancar la app.</li>
</ul>
</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="cloudkit">CloudKit<a class="headerlink" href="#cloudkit" title="Permanent link">&para;</a></h2>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="introduccion-a-cloudkit">Introducción a CloudKit<a class="headerlink" href="#introduccion-a-cloudkit" title="Permanent link">&para;</a></h2>
<!-- .slide: class="image-right"-->

<p><img style="margin-left:20px" src="imagenes/cloudkit-base-otras-tecnologias.png" width="500px"/></p>
<ul>
<li>CloudKit es un proyecto interno de Apple en el que se basan muchas
  de sus APIs de persistencia.</li>
<li>Su uso se ofrece a les desarrolladores en la WWDC de 2014, para apps
  a partir de iOS 8.</li>
<li>Acceso a servidores de iCloud.</li>
<li>Usa las cuentas iCloud de los usuarios.</li>
<li>Bases de datos públicas (de la app) y privadas (de cada usuario).</li>
<li>Permite datos estructurados y datos <em>bulk</em>.</li>
<li>Tecnología de transporte, no proporciona base de datos local.</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="cloudkit-trabaja-sobre-registros-en-icloud">CloudKit trabaja sobre registros en iCloud<a class="headerlink" href="#cloudkit-trabaja-sobre-registros-en-icloud" title="Permanent link">&para;</a></h2>
<ul>
<li>CloudKit proporciona una forma de mover datos estructurados entre tu
  aplicación y iCloud.</li>
<li>CloudKit trabaja sobre <strong>registros</strong>, <strong>diccionarios de parejas
  clave-valor con cada clave representando un campo del registro</strong>.</li>
<li>El valor de cada campo suele ser un tipo de datos simple como una
  cadena, una fecha o un número, pero es posible almacenar también
  bloques de datos arbitrarios (ficheros),</li>
<li>Es posible guardar en los valores <strong>referencias a otros registros</strong>,
  permitiendo definir relaciones entre registros.</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="registros-publicos-y-privados">Registros públicos y privados<a class="headerlink" href="#registros-publicos-y-privados" title="Permanent link">&para;</a></h2>
<ul>
<li>Se pueden guardar registros de forma pública y privada, dependiendo
  de si se guardan en la <strong>base de datos pública o en la privada</strong>.</li>
<li>Los registros públicos son accesibles a todos los usuarios de la
  app, aunque el usuario no se haya identificado con su cuenta de
  iCloud.</li>
<li>Los registros privados son sólo visibles por el usuario actual
  logeado en iCloud.</li>
<li>Para salvar registros en la base de datos pública es necesario que
  el usuario esté identificado, porque siempre se guarda el usuario
  propietario del registro.</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="tecnologia-de-transporte">Tecnología de transporte<a class="headerlink" href="#tecnologia-de-transporte" title="Permanent link">&para;</a></h2>
<ul>
<li>CloudKit no proporciona ninguna forma de almacenar datos localmente.</li>
<li>Es un servicio para <strong>mover datos a y desde iCloud</strong> y no está pensado
  para reemplazar los modelos de datos ya existentes en tu app
  (CoreData).</li>
<li>El objetivo del framework es complementar estos modelos con una
  forma de empaquetar los datos para iCloud y recibir actualizaciones
  posteriores sobre esos datos.</li>
<li>Con CloudKit, tu eres el responsable de mover los datos desde tu app
  a iCloud y desde iCloud a la app. Aunque CloudKit proporciona
  facilidades para mantenerte informado cuando sucede un cambio, tu
  debes obtener esos cambios explícitamente.</li>
<li>Debido a que eres el responsable de obtener y salvar los datos,
  debes de asegurarte de que los datos se obtienen en el momento
  oportuno y en el orden correcto, y de manejar los errores que se
  producen.</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="elementos-de-cloudkit">Elementos de CloudKit<a class="headerlink" href="#elementos-de-cloudkit" title="Permanent link">&para;</a></h2>
<ul>
<li>Contenedores</li>
<li>Bases de datos</li>
<li>Registros</li>
<li>Zonas de registros</li>
<li>Identificadores</li>
<li>Referencias </li>
<li><em>Assets</em></li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="contenedores">Contenedores<a class="headerlink" href="#contenedores" title="Permanent link">&para;</a></h2>
<!-- .slide: class="image-right"-->

<p><img style="margin-left:20px" src="imagenes/containers.png" width="400px"/></p>
<ul>
<li>Múltiples apps y usuarios tienen acceso a iCloud, pero los datos se
  encuentran segregados y encapsulados en particiones llamadas
  <code>contenedores</code>.</li>
<li>Los contenedores de tus apps no pueden ser usados por apps de otro
  desarrollador.</li>
<li>Puedes <strong>compartir un contenedor entre varias apps</strong>.</li>
<li>Existe un contenedor por defecto para cada app, pero puedes crear
  contenedores adicionales.</li>
<li>El identificador por defecto se llama igual que el bundle ID de la
  app.</li>
<li>Los contenedores adicionales deben tener un nombre único entre todas
  las apps de los desarrolladores.</li>
<li><strong>Los contenedores no pueden borrarse.</strong></li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="gestion-en-el-member-center">Gestión en el <em>member center</em><a class="headerlink" href="#gestion-en-el-member-center" title="Permanent link">&para;</a></h2>
<p><img src="imagenes/member-center-icloud-container.png" width="750px" /></p>
<ul>
<li>Una de las opciones del <em>member center</em> permite gestionar
  contenedores de iCloud.</li>
<li>Creamos uno con el identificador <code>iCloud.ua.mastermoviles.ToDoListCloudKit</code> que utilizaremos en la app <em>ToDoList</em>.</li>
<li>No es posible borrar contenedores.</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="asignacion-del-container-al-app-id">Asignación del container al App ID<a class="headerlink" href="#asignacion-del-container-al-app-id" title="Permanent link">&para;</a></h2>
<ul>
<li>Incluimos en el App ID el contenedor de iCloud anterior.</li>
</ul>
<p><img src="imagenes/aprovisionamiento-icloud-container.png" width="700px"/> </p>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="creacion-del-perfil-de-aprovisionamiento">Creación del perfil de aprovisionamiento<a class="headerlink" href="#creacion-del-perfil-de-aprovisionamiento" title="Permanent link">&para;</a></h2>
<ul>
<li>Creamos el perfil de aprovisionamiento <code>UA ToDoListCloudKit Profile</code>
  con el App ID anterior.</li>
</ul>
<p><img src="imagenes/aprovisionamiento-icloud.png" width="700px"/></p>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="actualizacion-de-capacidades-de-la-app-todolistcloudkit">Actualización de capacidades de la app ToDoListCloudKit<a class="headerlink" href="#actualizacion-de-capacidades-de-la-app-todolistcloudkit" title="Permanent link">&para;</a></h2>
<p><img src="imagenes/configuracion-firma.png" width="470px"/> <img
src="imagenes/capabilities.png" width="470px"/></p>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="dashboard">Dashboard<a class="headerlink" href="#dashboard" title="Permanent link">&para;</a></h2>
<!-- .slide: class="image-right"-->

<ul>
<li><em>Dashboard</em> es una interfaz web con la que podemos gestionar
  nuestros contenedores</li>
<li>El administrador del equipo de desarrollo puede gestionar permisos
  para el resto de miembros. Los permisos se definen a nivel de
  contenedor.</li>
<li><a href="https://icloud.developer.apple.com/dashboard/">https://icloud.developer.apple.com/dashboard/</a></li>
</ul>
<p><img style="margin-left:20px" src="imagenes/dashboard.png" width="600px"/></p>
<ul>
<li>Permite:<ul>
<li>Crear, visualizar, editar y borrar esquemas, registros, etc.</li>
<li>Estadísticas de uso</li>
<li>Administración de acceso</li>
<li>Configuración de despliegue</li>
</ul>
</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="dashboard-permisos">Dashboard: permisos<a class="headerlink" href="#dashboard-permisos" title="Permanent link">&para;</a></h2>
<ul>
<li>Comprobamos los permisos de los miembros del equipo de la
  universidad en el <em>dashboard</em> de iCloud.</li>
</ul>
<p><img src="imagenes/dashboard-permisos.png" width="600px"/></p>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="dashboard-tipos-de-registros">Dashboard: tipos de registros<a class="headerlink" href="#dashboard-tipos-de-registros" title="Permanent link">&para;</a></h2>
<p><img src="imagenes/dashboard-records.png" width="900px"/></p>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="dashboard-logs">Dashboard: logs<a class="headerlink" href="#dashboard-logs" title="Permanent link">&para;</a></h2>
<p><img src="imagenes/dashboard-logs.png" width="900px"/></p>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="clase-ckcontainer">Clase CKContainer<a class="headerlink" href="#clase-ckcontainer" title="Permanent link">&para;</a></h2>
<ul>
<li>La clase con la que trabajar para gestionar el contenedor es
  <a href="https://developer.apple.com/library/ios/documentation/CloudKit/Reference/CKContainer_class/index.html#//apple_ref/occ/cl/CKContainer">CKContainer</a></li>
<li>La debemos usar para:</li>
<li>Obtener las bases de datos públicas y privadas</li>
<li>Obtener el identificador del contenedor</li>
<li>Determinar el estado del acceso de la cuenta iCloud del usuario</li>
<li>Solicitar y determinar permisos de la app</li>
<li>Ejecutar operaciones sobre el contenedor</li>
<li>Descubrir registros de usuarios </li>
<li>En CloudKit todas las operaciones son asíncronas: se pasa el código
  de <em>callback</em> al que se llamará cuando la petición devuelva la
  respuesta.</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="caracteristicas-sociales-de-cloudkit">Características sociales de CloudKit<a class="headerlink" href="#caracteristicas-sociales-de-cloudkit" title="Permanent link">&para;</a></h2>
<!-- .slide: class="image-right"-->

<p><img style="margin-left:20px" src="imagenes/cloudkit-permiso.png" width="250px"/></p>
<ul>
<li>CloudKit permite descubrirse entre ellos a usuarios que están usando
  nuestra app. Los usuarios podrán compartir datos de identidad
  (nombre de usuario y correo elctrónico) si:<ul>
<li>Están en los contactos del usuario actual</li>
<li>Han dado el permiso a la app</li>
</ul>
</li>
<li>Para que otros usuarios puedan acceder a la información del usuario
  actual, hay que solicitarle su aprobación llamando a la función
  <a href="https://developer.apple.com/reference/cloudkit/ckcontainer/1399174-requestapplicationpermission"><code>requestApplicationPermission</code></a></li>
<li>Se le pasa como parámetro <code>completionHandler</code> el manejador de la
  respuesta del usuario. Recibiremos dos parámetros, el
  <code>applicationPermissionStatus</code> (constante que indica lo que ha
  respondido el usuario) y un objeto <code>error</code> que será <code>nil</code> si todo ha
  ido correctamente.</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="caracteristicas-sociales-de-cloudkit_1">Características sociales de CloudKit<a class="headerlink" href="#caracteristicas-sociales-de-cloudkit_1" title="Permanent link">&para;</a></h2>
<ul>
<li>Se pueden buscar los usuarios que han dado permiso y que están en la
  agenda del usuario actual por su dirección de correo electrónico
  registrada en el Apple Id.</li>
<li>La función
  <a href="https://developer.apple.com/reference/cloudkit/ckcontainer/1640421-discoverallidentities"><code>discover​All​Identities(completion​Handler:​)</code></a>
  de <code>CKContainer</code> permite obtener estos usuarios<ul>
<li>Se le pasa como parámetro <code>completionHandler</code>, una función que
  la consulta ejecutará cuando se obtengan los resultados. Tiene
  dos parámetros:<ul>
<li>Un array de objetos <code>CKUser​Identity</code> que corresponde con los
contactos del usuario que han autorizado conocerlos. Si no hay
usuarios, el array estará vacío.</li>
<li>Un objeto error si sucede algún problema, o <code>nil</code> si los IDs
  se han obtenido correctamente.</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="ejemplo-de-codigo-de-caracteristicas-sociales">Ejemplo de código de características sociales<a class="headerlink" href="#ejemplo-de-codigo-de-caracteristicas-sociales" title="Permanent link">&para;</a></h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">let</span> <span class="nv">container</span> <span class="p">=</span> <span class="bp">CKContainer</span><span class="p">.</span><span class="k">default</span><span class="p">()</span>
<span class="bp">print</span><span class="p">(</span><span class="s">&quot;Container: &quot;</span><span class="p">)</span>
<span class="bp">print</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
<span class="c1">// Solicitamos permiso para que el usuario se haga descubrible</span>
<span class="n">container</span><span class="p">.</span><span class="n">requestApplicationPermission</span><span class="p">(</span>
    <span class="n">CKApplicationPermissions</span><span class="p">.</span><span class="n">userDiscoverability</span><span class="p">,</span>
    <span class="n">completionHandler</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">permissionStatus</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Permiso concedido: &quot;</span> <span class="o">+</span>
            <span class="s">&quot;</span><span class="si">\(</span><span class="n">permissionStatus</span> <span class="p">==</span> <span class="n">CKApplicationPermissionStatus</span><span class="p">.</span><span class="n">granted</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)})</span>

<span class="c1">// Obtenemos los usuarios de la app que han dado permiso</span>
<span class="n">container</span><span class="p">.</span><span class="n">discoverAllIdentities</span><span class="p">(</span><span class="n">completionHandler</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">optUsers</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">if</span> <span class="kd">let</span> <span class="nv">users</span> <span class="p">=</span> <span class="n">optUsers</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">user</span> <span class="k">in</span> <span class="n">users</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="c1">// usamos user.userRecordID para buscar</span>
            <span class="c1">// registros públicos de un usuario</span>
        <span class="p">}</span>
    <span class="p">}})</span>
</pre></div>
</td></tr></table>

<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="bases-de-datos">Bases de datos<a class="headerlink" href="#bases-de-datos" title="Permanent link">&para;</a></h2>
<p><img src="imagenes/database-container.png" width="1000px"/></p>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="bases-de-datos_1">Bases de datos<a class="headerlink" href="#bases-de-datos_1" title="Permanent link">&para;</a></h2>
<p><img src="imagenes/database-container-2.png" width="1000px"/></p>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="bases-de-datos_2">Bases de datos<a class="headerlink" href="#bases-de-datos_2" title="Permanent link">&para;</a></h2>
<ul>
<li>Las bases de datos son instancias de la clase
  <a href="https://developer.apple.com/library/ios/documentation/CloudKit/Reference/CKDatabase_class/index.html#//apple_ref/occ/cl/CKDatabase"><code>CKDatabase</code></a></li>
<li>Cada app tiene acceso a dos bases de datos</li>
<li>Base de datos pública</li>
<li>Base de datos privada</li>
<li>Se obtienen a través del <code>CKContainer</code>:</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">let</span> <span class="nv">container</span> <span class="p">=</span> <span class="bp">CKContainer</span><span class="p">.</span><span class="k">default</span><span class="p">()</span>
<span class="kd">let</span> <span class="nv">privateDB</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">privateCloudDatabase</span>
<span class="kd">let</span> <span class="nv">publicDB</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">publicCloudDatabase</span>
</pre></div>
</td></tr></table>

<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="bases-de-datos_3">Bases de datos<a class="headerlink" href="#bases-de-datos_3" title="Permanent link">&para;</a></h2>
<p><img src="imagenes/databases-permisos.png" width="1000px"/></p>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="registros">Registros<a class="headerlink" href="#registros" title="Permanent link">&para;</a></h2>
<p><img src="imagenes/records.png" width="700px"/></p>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="creacion-de-registros">Creación de registros<a class="headerlink" href="#creacion-de-registros" title="Permanent link">&para;</a></h2>
<ul>
<li>Se definen con la clase
  <a href="https://developer.apple.com/library/ios/documentation/CloudKit/Reference/CKRecord_class/">CKRecord</a>.</li>
<li>Conjunto de parejas clave y valor con un identificador único de la
  clase. <a href="https://developer.apple.com/library/ios/documentation/CloudKit/Reference/CKRecordID_class/index.html#//apple_ref/occ/cl/CKRecordID"><code>CKRecordID</code></a></li>
<li>Se crean en tiempo de ejecución indicando un tipo de registro
  definido por un <code>String</code>.</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">let</span> <span class="nv">tareaRecord</span> <span class="p">=</span> <span class="bp">CKRecord</span><span class="p">(</span><span class="n">recordType</span><span class="p">:</span> <span class="s">&quot;Artista&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<ul>
<li>Una vez creado el registro se añaden valores a sus campos (que
  también se crean dinámicamente):</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>let nombre = &quot;Jonhn Lennon&quot;
tareaRecord[&quot;artista&quot;] = nombre as NSString
let formatter = DateFormatter()
formatter.dateFormat = &quot;yyyy/MM/dd&quot;
let fecha = formatter.date(from: &quot;1940/10/09&quot;)
tareaRecord[&quot;fechanacimiento&quot;] = fecha! as NSDate
</pre></div>
</td></tr></table>

<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="datos-en-los-registros">Datos en los registros<a class="headerlink" href="#datos-en-los-registros" title="Permanent link">&para;</a></h2>
<ul>
<li>El protocolo
<a href="https://developer.apple.com/reference/cloudkit/ckrecordvalue">CKRecordValue</a>
define los posibles valores que pueden haber en los atributos de los registros:<ul>
<li><code>NSString</code>: Cadenas</li>
<li><code>NSNumber</code>: Números, incluidos enteros y punto flotante.</li>
<li><code>NSData</code>: Bytes arbitrarios de datos (por ejemplo, la
  serialización binaria de un <code>struct</code>. No usar para almacenar
  ficheros binarios grandes, usar <code>CKAsset</code> en su lugar.</li>
<li><code>NSDate</code>: Fechas</li>
<li><code>CLLocation</code>: Coordenadas geográficas</li>
<li><code>CKReference</code>: Referencias a otros registros para crear relaciones entre ellos.</li>
<li><code>CKAsset</code>: Fichero binario.</li>
<li>Arrays de todo lo anterior</li>
</ul>
</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="grabacion-de-registros">Grabación de registros<a class="headerlink" href="#grabacion-de-registros" title="Permanent link">&para;</a></h2>
<ul>
<li>Se añaden registros a una base de datos usando la función
  <a href="https://developer.apple.com/reference/cloudkit/ckdatabase/1449114-save"><code>save</code></a>,
  a la que hay que pasar un bloque que recibe el registro salvado y un
  error (en caso en que no se haya podido salvar).</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">privateDB</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">tareaRecord</span><span class="p">,</span> <span class="n">completionHandler</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="bp">CKRecord</span><span class="p">?,</span> <span class="n">error</span><span class="p">:</span> <span class="n">Error</span><span class="p">?)</span> <span class="p">-&gt;</span> <span class="nb">Void</span> <span class="k">in</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Registro: </span><span class="si">\(</span><span class="n">record</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Error: </span><span class="si">\(</span><span class="n">error</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)})</span>
</pre></div>
</td></tr></table>

<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="relaciones-entre-registros-referencias">Relaciones entre registros: referencias<a class="headerlink" href="#relaciones-entre-registros-referencias" title="Permanent link">&para;</a></h2>
<p><img src="imagenes/referencias.png" width="700px"/></p>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="referencias">Referencias<a class="headerlink" href="#referencias" title="Permanent link">&para;</a></h2>
<!-- .slide: class="image-right"-->

<p><img style="margin-left:20px" src="imagenes/ckreference_owner_owned.png" width="600px"/></p>
<ul>
<li>Clase
  <a href="https://developer.apple.com/library/ios/documentation/CloudKit/Reference/CKReference_class/index.html#//apple_ref/occ/cl/CKReference">CKReference</a></li>
<li>El servidor entiende las relaciones <em>Padre</em> <em>Hijo</em></li>
<li>Borrados en cascada</li>
<li>Cuidado con los problemas de integridad, será normal que no existan
  referencias</li>
<li>Se prefieren las referencias hacia atrás para modelar las relaciones
  anteriores</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="queries">Queries<a class="headerlink" href="#queries" title="Permanent link">&para;</a></h2>
<ul>
<li>Para realizar una consulta se debe utilizar la clase
  <a href="https://developer.apple.com/library/ios/documentation/CloudKit/Reference/CKQuery_class/index.html#//apple_ref/occ/cl/CKQuery"><code>CKQuery</code></a>
  para buscar objetos que cumplen una determinada condición en una
  base de datos.</li>
<li>La consulta almacena los parámetros de búsqueda, incluyendo el tipo
  de registros a buscar, el criterio (predicado) a aplicar, y el
  parámetro de ordenación que aplicar a los resultados.</li>
<li>El objeto de la búsqueda se usa para ejecutar una consulta en la
  base de datos usando el método
  <a href="https://developer.apple.com/reference/cloudkit/ckdatabase/1449127-perform"><code>perform</code></a>
  Se le pasa un manejador al que se llamará cuando se obtengan los
  resultados. La operación de búsqueda se restringe a los objetos de
  una zona (se pasa <code>nil</code> para la zona por defecto).</li>
<li>Para realizar consultas con más control sobre el número de registros
  devueltos, o utilizar un cursor definido por el límite de registros
  devueltos, hay que realizar una
  <a href="https://developer.apple.com/library/ios/documentation/CloudKit/Reference/CKQueryOperation_class/index.html#//apple_ref/occ/cl/CKQueryOperation"><code>CKQueryOperation</code></a>.</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="ejemplo">Ejemplo<a class="headerlink" href="#ejemplo" title="Permanent link">&para;</a></h2>
<ul>
<li>Query que devuelve todos los registros de tipo "Tarea" de la base de
  datos privada del usuario actual</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">let</span> <span class="nv">query</span> <span class="p">=</span> <span class="bp">CKQuery</span><span class="p">(</span><span class="n">recordType</span><span class="p">:</span> <span class="s">&quot;Tarea&quot;</span><span class="p">,</span> <span class="n">predicate</span><span class="p">:</span> <span class="bp">NSPredicate</span><span class="p">(</span><span class="n">value</span><span class="p">:</span><span class="kc">true</span><span class="p">))</span>
<span class="kd">let</span> <span class="nv">container</span> <span class="p">=</span> <span class="bp">CKContainer</span><span class="p">.</span><span class="k">default</span><span class="p">()</span>
<span class="kd">let</span> <span class="nv">privateDB</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">privateCloudDatabase</span>
<span class="n">privateDB</span><span class="p">.</span><span class="n">perform</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">inZoneWith</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">completionHandler</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">for</span> <span class="n">result</span> <span class="k">in</span> <span class="n">results</span><span class="p">!</span> <span class="p">{</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nv">nombre</span> <span class="p">=</span> <span class="n">result</span><span class="p">[</span><span class="s">&quot;nombre&quot;</span><span class="p">]</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Tarea: </span><span class="si">\(</span><span class="n">nombre</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="kd">let</span> <span class="nv">toDoItem</span> <span class="p">=</span> <span class="n">ToDoItem</span><span class="p">(</span><span class="n">nombre</span><span class="p">:</span> <span class="n">nombre</span> <span class="k">as</span><span class="p">!</span> <span class="nb">String</span><span class="p">)</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">toDoItems</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">toDoItem</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">})</span>
</pre></div>
</td></tr></table>

<ul>
<li>Otros ejemplos de predicados (consultar
  <a href="https://developer.apple.com/reference/cloudkit/ckquery">CKQuery</a> y <a href="https://developer.apple.com/reference/foundation/nspredicate">NSPredicate</a>)</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">let</span> <span class="nv">predicate</span> <span class="p">=</span> <span class="bp">NSPredicate</span><span class="p">(</span><span class="n">format</span><span class="p">:</span> <span class="s">&quot;nombre BEGINSWITH &#39;Limpiar&#39;&quot;</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">predicate</span> <span class="p">=</span> <span class="bp">NSPredicate</span><span class="p">(</span><span class="n">format</span><span class="p">:</span> <span class="s">&quot;favoriteColors CONTAINS &#39;red&#39;&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="operaciones-con-registros-obtenidos">Operaciones con registros obtenidos<a class="headerlink" href="#operaciones-con-registros-obtenidos" title="Permanent link">&para;</a></h2>
<ul>
<li>Un ejemplo de código en el que borramos los registros de tipo
  "Tarea" cuyo nombre coincide con un nombre:</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">deleteTarea</span><span class="p">(</span><span class="kc">_</span> <span class="n">nombre</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">query</span> <span class="p">=</span> <span class="bp">CKQuery</span><span class="p">(</span><span class="n">recordType</span><span class="p">:</span> <span class="s">&quot;Tarea&quot;</span><span class="p">,</span> 
                     <span class="n">predicate</span><span class="p">:</span> <span class="bp">NSPredicate</span><span class="p">(</span><span class="n">format</span><span class="p">:</span> <span class="s">&quot;nombre == %@&quot;</span><span class="p">,</span> <span class="n">argumentArray</span><span class="p">:</span> <span class="p">[</span><span class="n">nombre</span><span class="p">]))</span>
    <span class="kd">let</span> <span class="nv">container</span> <span class="p">=</span>  <span class="bp">CKContainer</span><span class="p">.</span><span class="k">default</span><span class="p">()</span>
    <span class="kd">let</span> <span class="nv">privateDB</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">privateCloudDatabase</span>
    <span class="n">privateDB</span><span class="p">.</span><span class="n">perform</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">inZoneWith</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">completionHandler</span><span class="p">:</span> <span class="p">{</span>
        <span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">if</span> <span class="n">error</span> <span class="p">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">for</span> <span class="n">result</span> <span class="k">in</span> <span class="n">results</span><span class="p">!</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nv">record</span><span class="p">:</span> <span class="bp">CKRecord</span><span class="p">!</span> <span class="p">=</span> <span class="n">result</span> <span class="k">as</span> <span class="bp">CKRecord</span>
                <span class="n">privateDB</span><span class="p">.</span><span class="n">delete</span><span class="p">(</span><span class="n">withRecordID</span><span class="p">:</span> <span class="n">record</span><span class="p">.</span><span class="n">recordID</span><span class="p">,</span> <span class="n">completionHandler</span><span class="p">:</span> <span class="p">{</span>
                    <span class="p">(</span><span class="n">recordID</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span> <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Error: </span><span class="si">\(</span><span class="n">error</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="suscripciones">Suscripciones<a class="headerlink" href="#suscripciones" title="Permanent link">&para;</a></h2>
<p><img src="imagenes/subscription.png" width="600px"/></p>
<ul>
<li>Posibilidad de hacer consultas "permanentes"</li>
<li>Ejecutadas en background por el servidor tras cada registro salvado</li>
<li>Generan notificaciones push con los resultados</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="cloudkit-js">CloudKit JS<a class="headerlink" href="#cloudkit-js" title="Permanent link">&para;</a></h2>
<!-- .slide: class="image-right"-->

<p><img style="margin-left:20px" src="imagenes/cloudkit-webservices.png" width="450px"/></p>
<ul>
<li><a href="https://developer.apple.com/library/ios/documentation/CloudKitJS/Reference/CloudKitJavaScriptReference/index.html">CloudKit JS</a>
  es una librería que proporciona un API JavaScript para acceder a los
  datos en los contenedores CloudKit.</li>
<li>Lanzado en WWDC 2015.</li>
<li>Necesita un token generado en el dashboard para acceso seguro al API
  en la conexión servidor-servidor.</li>
<li>Permite autentificarse y realizar peticiones seguras JavaScript
  desde una aplicación web para acceder a los datos de CloudKit.</li>
<li>Sistema usado por la interfaz web de las apps de Apple en la página
  web de iCloud (Notas, Photos, etc.)</li>
<li>En 2016 Apple ha lanzado un
  <a href="https://developer.apple.com/library/ios/documentation/DataManagement/Conceptual/CloutKitWebServicesReference/Introduction/Introduction.html">servicio web</a>
  para acceder a CloudKit usando peticiones REST.</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="practica-todolist-con-icloud-clave-valor-1">Práctica: ToDoList con iCloud clave-valor (1)<a class="headerlink" href="#practica-todolist-con-icloud-clave-valor-1" title="Permanent link">&para;</a></h2>
<p><!-- .slide: class="image-right"-->
<!-- .slide: data-background="#cbe0fc"--></p>
<p><img style="margin-left:20px" src="imagenes/to-do-list-alerta.png"
width="180px"/> </p>
<p><img style="margin-left:20px" src="imagenes/to-do-list.png"
width="180px"/></p>
<ul>
<li>Preparación previa<ul>
<li>Copia la carpeta <code>ToDoList</code> y renómbrala a <code>ToDoList  CloudKit</code>.</li>
<li>Elimina las referencias a <code>Fabric</code> y <code>Crashlytics</code></li>
<li>El <em>bundle ID</em> de la app debe ser
  <code>es.ua.mastermoviles.ToDoListCloudKit</code> y utilizar el
  perfil de aprovisionamiento <code>UA ToDoListCloudKit Profile</code>.</li>
<li>Activa la <em>capability</em> de iCloud clave-valor.</li>
</ul>
</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="practica-todolist-con-icloud-clave-valor-2_1">Práctica: ToDoList con iCloud clave-valor (2)<a class="headerlink" href="#practica-todolist-con-icloud-clave-valor-2_1" title="Permanent link">&para;</a></h2>
<!-- .slide: class="image-right"-->

<!-- .slide: data-background="#cbe0fc"-->

<p><img style="margin-left:20px" src="imagenes/to-do-list-alerta.png"
width="180px"/> </p>
<p><img style="margin-left:20px" src="imagenes/to-do-list.png"
width="180px"/></p>
<ul>
<li>Debes modificar la aplicación para que se guarden en el almacén clave-valor
  de iCloud del usuario:<ul>
<li>Número de tareas terminadas</li>
<li>Última tarea terminada</li>
<li>Debes usar la app en el simulador habiéndote logeado en iCloud en el
propio simulador.</li>
<li>Prueba a ejecutar distintas veces la app desde el simulador,
  incluso a eliminar la aplicación y volver a instalarla. Debería
  conservarse el número de tareas terminadas y el nombre de la
  última. Se borrarán las tareas pendientes (las guardaremos en
  CloudKit en la sesión siguiente).</li>
<li>Muestra los datos guardados con una
  <a href="https://developer.apple.com/reference/uikit/uialertcontroller">alerta</a>
  al arrancar la app.</li>
</ul>
</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="practica-todolist-en-cloudkit">Práctica: ToDoList en CloudKit<a class="headerlink" href="#practica-todolist-en-cloudkit" title="Permanent link">&para;</a></h2>
<!-- .slide: class="image-right"-->

<!-- .slide: data-background="#cbe0fc"-->

<p><img style="margin-left:20px" src="imagenes/to-do-list.png" width="200px"/></p>
<ul>
<li>Configuración de la app:<ul>
<li>Trabajamos con el proyecto <code>ToDoList CloudKit</code> y el <em>bundle ID</em>
  <code>es.ua.mastermoviles.ToDoListCloudKit</code> y el perfil de
  aprovisionamiento <code>UA ToDoListCloudKit Profile</code>.</li>
<li>Arregla el <em>storyboard</em> de la app (hay una vista de navegación de más).</li>
</ul>
</li>
<li>Desarrollo de la práctica:<ul>
<li>Añade el código necesario para que las tareas pendientes
  se guarden y recuperen de la base de datos privada de
  CloudKit.</li>
<li>(Opcional): Utiliza la base de datos pública para
 publicar tareas compartidas por todos los usuarios de la
 app. Muestra el texto de las tareas públicas en un color
 diferente en el listado de tareas.</li>
</ul>
</li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="pista-para-actualizar-la-tabla">Pista para actualizar la tabla<a class="headerlink" href="#pista-para-actualizar-la-tabla" title="Permanent link">&para;</a></h2>
<!-- .slide: data-background="#cbe0fc"-->

<ul>
<li>Los <em>callbacks</em> en los que se reciben los resultados de las
  <em>queries</em> son asíncronos y se procesan en hilos secundarios.</li>
<li>Si actualizamos los datos de la tabla en un <em>callback</em> de este tipo,
  la interfaz de usuario no se refrescará hasta que el usuario no
  interactúe con la tabla.</li>
<li>Se puede forzar a ejecutar la actualización de los datos de la tabla en
  el hijo principal con este código en algún lugar del <code>ToDoListTableViewController</code>:</li>
</ul>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">async</span><span class="p">(</span> <span class="n">execute</span><span class="p">:</span> <span class="p">{</span>
    <span class="kc">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">reloadData</span><span class="p">()</span>
<span class="p">})</span>
</pre></div>
</td></tr></table>

<!-- Tres líneas en blanco para la siguiente transparencia -->

<h2 id="referencias_1">Referencias<a class="headerlink" href="#referencias_1" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://developer.apple.com/icloud/index.html">Recursos sobre iCloud</a></li>
<li><a href="https://developer.apple.com/documentation/cloudkit">Referencia Framework CloudKit</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/General/Conceptual/iCloudDesignGuide/Chapters/Introduction.html#//apple_ref/doc/uid/TP40012094">iCloud Design Guide</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/DataManagement/Conceptual/CloudKitQuickStart/Introduction/Introduction.html#//apple_ref/doc/uid/TP40014987">CloudKit Quick Start</a></li>
</ul>
<!-- Tres líneas en blanco para la siguiente transparencia -->

<h1 id="master-programacion-de-dispositivos-moviles">Master Programación <br/> de Dispositivos Móviles<a class="headerlink" href="#master-programacion-de-dispositivos-moviles" title="Permanent link">&para;</a></h1>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.583bbe55.js"></script>
      
        
        
          
          <script src="../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
              
                <script src="../assets/javascripts/lunr/lunr.es.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>