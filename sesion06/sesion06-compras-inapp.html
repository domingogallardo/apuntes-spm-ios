



<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copiar al portapapeles">
      
        <meta name="lang:clipboard.copied" content="Copiado al portapapeles">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No se encontraron documentos">
      
        <meta name="lang:search.result.one" content="1 documento encontrado">
      
        <meta name="lang:search.result.other" content="# documentos encontrados">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.1.1">
    
    
      
        <title>Sesión 6 - Anuncios y Compras In-App - SPM-iOS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.3020aac5.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="../assets/javascripts/modernizr.01ccdecf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#sesion-6-anuncios-y-compras-in-app" tabindex="1" class="md-skip">
        Saltar a contenido
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="SPM-iOS" class="md-header-nav__button md-logo">
          
            <img src="../imagenes/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              SPM-iOS
            </span>
            <span class="md-header-nav__topic">
              Sesión 6 - Anuncios y Compras In-App
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Teclee para comenzar búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="SPM-iOS" class="md-nav__button md-logo">
      
        <img src="../imagenes/logo.png" width="48" height="48">
      
    </a>
    SPM-iOS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../sesion00/sesion00-introduccion.html" title="Introducción" class="md-nav__link">
      Introducción
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../sesion01/sesion01-firma-aprovisionamiento.html" title="Sesión 1 - Firma, aprovisionamiento y distribución de apps" class="md-nav__link">
      Sesión 1 - Firma, aprovisionamiento y distribución de apps
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../sesion02/sesion02-notificaciones.html" title="Sesión 2 - Notificaciones" class="md-nav__link">
      Sesión 2 - Notificaciones
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../sesion03/sesion03-icloud.html" title="Sesión 3 - iCloud" class="md-nav__link">
      Sesión 3 - iCloud
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../sesion04/sesion04-mapas-localizacion.html" title="Sesión 4 - Mapas y localización" class="md-nav__link">
      Sesión 4 - Mapas y localización
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../sesion05/sesion05-extensiones.html" title="Sesión 5 - Extensiones" class="md-nav__link">
      Sesión 5 - Extensiones
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Sesión 6 - Anuncios y Compras In-App
      </label>
    
    <a href="sesion06-compras-inapp.html" title="Sesión 6 - Anuncios y Compras In-App" class="md-nav__link md-nav__link--active">
      Sesión 6 - Anuncios y Compras In-App
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#anuncios" title="Anuncios" class="md-nav__link">
    Anuncios
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#redes-de-anuncios" title="Redes de anuncios" class="md-nav__link">
    Redes de anuncios
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-de-admob" title="API de AdMob" class="md-nav__link">
    API de AdMob
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#alta-en-admob" title="Alta en AdMob" class="md-nav__link">
    Alta en AdMob
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#importar-el-sdk-de-anuncios-para-moviles" title="Importar el SDK de anuncios para móviles" class="md-nav__link">
    Importar el SDK de anuncios para móviles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#actualizar-el-fichero-infoplist" title="Actualizar el fichero Info.plist" class="md-nav__link">
    Actualizar el fichero Info.plist
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inicializacion-del-api" title="Inicialización del API" class="md-nav__link">
    Inicialización del API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#seleccion-del-formato-de-anuncio" title="Selección del formato de anuncio" class="md-nav__link">
    Selección del formato de anuncio
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementacion-de-un-banner" title="Implementación de un banner" class="md-nav__link">
    Implementación de un banner
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementacion-de-un-interstitial" title="Implementación de un interstitial" class="md-nav__link">
    Implementación de un interstitial
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demo-aplicacion-de-prueba" title="Demo: Aplicación de prueba" class="md-nav__link">
    Demo: Aplicación de prueba
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compras-in-app" title="Compras In-App" class="md-nav__link">
    Compras In-App
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#que-es-una-compra-in-app" title="¿Qué es una compra In-App?" class="md-nav__link">
    ¿Qué es una compra In-App?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejemplos-de-uso" title="Ejemplos de uso" class="md-nav__link">
    Ejemplos de uso
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tipos-de-compras-in-app-compras" title="Tipos de compras In-App - Compras" class="md-nav__link">
    Tipos de compras In-App - Compras
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tipos-de-compras-in-app-suscripciones" title="Tipos de compras In-App - Suscripciones" class="md-nav__link">
    Tipos de compras In-App - Suscripciones
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#requisitos-para-activar-las-in-app" title="Requisitos para activar las In-App" class="md-nav__link">
    Requisitos para activar las In-App
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contratos" title="Contratos" class="md-nav__link">
    Contratos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servicios-a-activar-en-la-app" title="Servicios a activar en la app" class="md-nav__link">
    Servicios a activar en la app
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bundle-identifier-y-app-id" title="Bundle identifier y App Id" class="md-nav__link">
    Bundle identifier y App Id
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuracion-in-app-desde-itunes-connect" title="Configuración In-App desde iTunes Connect" class="md-nav__link">
    Configuración In-App desde iTunes Connect
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datos-del-app" title="Datos del app" class="md-nav__link">
    Datos del app
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pantalla-para-anadir-nuevos-in-apps" title="Pantalla para añadir nuevos In-Apps" class="md-nav__link">
    Pantalla para añadir nuevos In-Apps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#seleccionar-el-tipo-de-in-app" title="Seleccionar el tipo de In-App" class="md-nav__link">
    Seleccionar el tipo de In-App
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caracteristicas-del-in-app" title="Características del In-App" class="md-nav__link">
    Características del In-App
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caracteristicas-del-in-app_1" title="Características del In-App" class="md-nav__link">
    Características del In-App
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usuarios-de-prueba" title="Usuarios de prueba" class="md-nav__link">
    Usuarios de prueba
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demo" title="Demo" class="md-nav__link">
    Demo
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#codigo-para-implementar-las-compras-in-app" title="Código para implementar las compras In-App" class="md-nav__link">
    Código para implementar las compras In-App
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#el-proceso-de-compra-en-un-vistazo" title="El proceso de compra en un vistazo" class="md-nav__link">
    El proceso de compra en un vistazo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clase-auxiliar-inapp" title="Clase auxiliar InApp" class="md-nav__link">
    Clase auxiliar InApp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clase-viewcontroller" title="Clase ViewController" class="md-nav__link">
    Clase ViewController
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practica" title="Práctica" class="md-nav__link">
    Práctica
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" title="Referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#anuncios" title="Anuncios" class="md-nav__link">
    Anuncios
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#redes-de-anuncios" title="Redes de anuncios" class="md-nav__link">
    Redes de anuncios
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-de-admob" title="API de AdMob" class="md-nav__link">
    API de AdMob
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#alta-en-admob" title="Alta en AdMob" class="md-nav__link">
    Alta en AdMob
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#importar-el-sdk-de-anuncios-para-moviles" title="Importar el SDK de anuncios para móviles" class="md-nav__link">
    Importar el SDK de anuncios para móviles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#actualizar-el-fichero-infoplist" title="Actualizar el fichero Info.plist" class="md-nav__link">
    Actualizar el fichero Info.plist
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inicializacion-del-api" title="Inicialización del API" class="md-nav__link">
    Inicialización del API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#seleccion-del-formato-de-anuncio" title="Selección del formato de anuncio" class="md-nav__link">
    Selección del formato de anuncio
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementacion-de-un-banner" title="Implementación de un banner" class="md-nav__link">
    Implementación de un banner
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementacion-de-un-interstitial" title="Implementación de un interstitial" class="md-nav__link">
    Implementación de un interstitial
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demo-aplicacion-de-prueba" title="Demo: Aplicación de prueba" class="md-nav__link">
    Demo: Aplicación de prueba
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compras-in-app" title="Compras In-App" class="md-nav__link">
    Compras In-App
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#que-es-una-compra-in-app" title="¿Qué es una compra In-App?" class="md-nav__link">
    ¿Qué es una compra In-App?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ejemplos-de-uso" title="Ejemplos de uso" class="md-nav__link">
    Ejemplos de uso
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tipos-de-compras-in-app-compras" title="Tipos de compras In-App - Compras" class="md-nav__link">
    Tipos de compras In-App - Compras
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tipos-de-compras-in-app-suscripciones" title="Tipos de compras In-App - Suscripciones" class="md-nav__link">
    Tipos de compras In-App - Suscripciones
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#requisitos-para-activar-las-in-app" title="Requisitos para activar las In-App" class="md-nav__link">
    Requisitos para activar las In-App
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contratos" title="Contratos" class="md-nav__link">
    Contratos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servicios-a-activar-en-la-app" title="Servicios a activar en la app" class="md-nav__link">
    Servicios a activar en la app
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bundle-identifier-y-app-id" title="Bundle identifier y App Id" class="md-nav__link">
    Bundle identifier y App Id
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuracion-in-app-desde-itunes-connect" title="Configuración In-App desde iTunes Connect" class="md-nav__link">
    Configuración In-App desde iTunes Connect
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#datos-del-app" title="Datos del app" class="md-nav__link">
    Datos del app
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pantalla-para-anadir-nuevos-in-apps" title="Pantalla para añadir nuevos In-Apps" class="md-nav__link">
    Pantalla para añadir nuevos In-Apps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#seleccionar-el-tipo-de-in-app" title="Seleccionar el tipo de In-App" class="md-nav__link">
    Seleccionar el tipo de In-App
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caracteristicas-del-in-app" title="Características del In-App" class="md-nav__link">
    Características del In-App
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caracteristicas-del-in-app_1" title="Características del In-App" class="md-nav__link">
    Características del In-App
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usuarios-de-prueba" title="Usuarios de prueba" class="md-nav__link">
    Usuarios de prueba
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demo" title="Demo" class="md-nav__link">
    Demo
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#codigo-para-implementar-las-compras-in-app" title="Código para implementar las compras In-App" class="md-nav__link">
    Código para implementar las compras In-App
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#el-proceso-de-compra-en-un-vistazo" title="El proceso de compra en un vistazo" class="md-nav__link">
    El proceso de compra en un vistazo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clase-auxiliar-inapp" title="Clase auxiliar InApp" class="md-nav__link">
    Clase auxiliar InApp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clase-viewcontroller" title="Clase ViewController" class="md-nav__link">
    Clase ViewController
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#practica" title="Práctica" class="md-nav__link">
    Práctica
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" title="Referencias" class="md-nav__link">
    Referencias
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="sesion-6-anuncios-y-compras-in-app">Sesión 6: Anuncios y compras In-App<a class="headerlink" href="#sesion-6-anuncios-y-compras-in-app" title="Permanent link">&para;</a></h1>
<h2 id="anuncios">Anuncios<a class="headerlink" href="#anuncios" title="Permanent link">&para;</a></h2>
<h3 id="redes-de-anuncios">Redes de anuncios<a class="headerlink" href="#redes-de-anuncios" title="Permanent link">&para;</a></h3>
<p style="text-align:center;">
<img src="imagenes/iAd.png" width="300px"/>x
</p>

<p>Hasta 2016 Apple había explotado iAD, una red de anuncios propia, con
su propia API, orientada específicamente a apps iOS. Durante varios
años había intentado competir con las redes más populares como AdMob
(Google). Al final no consiguió destacar y la red se cerró en junio de
2016.</p>
<p>Desde entonces los desarrolladores iOS tienen que escoger entre
distintas redes existentes:</p>
<ul>
<li>AdMob (Google)</li>
<li>Unity Ads </li>
<li>Facebook Ads </li>
<li>Amazon Ads</li>
</ul>
<p>Cada red tiene su propia API, aunque son todas ellas muy similares.</p>
<p>Vamos a ver la red AdMob de Google, por ser la más popular. Vamos a
explicar AdMob <strong>sin Firebase</strong>, para hacer más ligera la app y tener
que depender del número mínimo de librerías.</p>
<p style="text-align:center;">
<img src="imagenes/google-admob.png" width="350px"/>
</p>

<h2 id="api-de-admob">API de AdMob<a class="headerlink" href="#api-de-admob" title="Permanent link">&para;</a></h2>
<h3 id="alta-en-admob">Alta en AdMob<a class="headerlink" href="#alta-en-admob" title="Permanent link">&para;</a></h3>
<p>Lo primero que tenemos que hacer para probar los anuncios y el API de
AdMob es <a href="https://support.google.com/admob/answer/2784575">crear una cuenta de
AdMob</a> y <a href="https://support.google.com/admob/answer/2773509">registrar
una aplicación</a>.</p>
<p>Una vez dado de alta y creada la aplicación, tendrás un número de
registro de la aplicación del estilo <code>ca-app-pub-6502933536055889~6323740433</code> </p>
<p>Puedes <a href="https://support.google.com/admob/answer/7356431">encontrar tu ID de
aplicación</a> en la
interfaz de AdMob.</p>
<p style="text-align:center;">
<img src="imagenes/admob-app.png" width="700px"/>
</p>

<h3 id="importar-el-sdk-de-anuncios-para-moviles">Importar el SDK de anuncios para móviles<a class="headerlink" href="#importar-el-sdk-de-anuncios-para-moviles" title="Permanent link">&para;</a></h3>
<p>La forma más sencilla de importar el SDK a un proyecto iOS es mediante
<a href="https://guides.cocoapods.org/using/getting-started">CocoaPods</a>.</p>
<p>Utilizando la instalación de Ruby que viene por defecto en MacOS
para instalar CocoaPods basta con hacer:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ sudo gem install cocoapods
</pre></div>
</td></tr></table>

<p>Supongamos que vamos a trabajar con la app ToDoList. En el directorio
raíz del proyecto debes crear el fichero <code>Podfile</code>, con el contenido:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>target &#39;ToDoList&#39; do
    pod &#39;Google-Mobile-Ads-SDK&#39;
end
</pre></div>
</td></tr></table>

<p>Después, desde línea de comando y estando en el directorio raíz del
proyecto, debes ejecutar:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ pod install --repo-update
</pre></div>
</td></tr></table>

<p>Se descargarán las librerías necesarias y se creará un fichero
<code>ToDoList.xcworkspace</code> que es el que debes abrir con Xcode. Al abrir
este fichero Xcode abrirá una configuración de <em>workspace</em> en la que
pueden existir más de un proyecto. Es la configuración que se usa para
trabajar con CocoaPods.</p>
<h3 id="actualizar-el-fichero-infoplist">Actualizar el fichero Info.plist<a class="headerlink" href="#actualizar-el-fichero-infoplist" title="Permanent link">&para;</a></h3>
<p>Añade una clave <code>GADApplicationIdentifier</code> con un valor de cadena igual
a tu ID de aplicación de AdMob al archivo <code>Info.plist</code> de tu
aplicación. Puedes encontrar tu ID de la aplicación en la interfaz de
AdMob.</p>
<p>Puedes hacerlo editando el fichero:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nt">&lt;key&gt;</span>GADApplicationIdentifier<span class="nt">&lt;/key&gt;</span>
<span class="nt">&lt;string&gt;</span>ca-app-pub-6502933536055889~6323740433<span class="nt">&lt;/string&gt;</span>
</pre></div>
</td></tr></table>

<p>O usando la interfaz de Xcode:</p>
<p style="text-align:center;">
<img src="imagenes/admob-infoplist.png" width="600px"/>
</p>

<h3 id="inicializacion-del-api">Inicialización del API<a class="headerlink" href="#inicializacion-del-api" title="Permanent link">&para;</a></h3>
<p>Antes de cargar anuncios, debemos inicializar el SDK de
anuncios de Google para móviles llamando al método
<code>start(ompletionHandler:)</code> de <code>GADMobileAds.sharedInstance()</code>, que
inicializa el SDK y hace una retrollamada al controlador de
finalización una vez que la inicialización se ha completado, o bien
después de un tiempo de espera de 30 segundos. </p>
<p>Solo es necesario hacerlo una vez, preferiblemente al iniciar la
aplicación. La llamada debe realizarse lo más pronto posible.</p>
<p>A continuación, tienes un ejemplo de cómo llamar al método
startWithCompletionHandler: en tu AppDelegate:</p>
<p>Ejemplo de <code>AppDelegate.swift</code> (fragmento)</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">import</span> <span class="nc">GoogleMobileAds</span>

<span class="kr">@UIApplicationMain</span>
<span class="kd">class</span> <span class="nc">AppDelegate</span><span class="p">:</span> <span class="bp">UIResponder</span><span class="p">,</span> <span class="bp">UIApplicationDelegate</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">application</span><span class="p">(</span><span class="kc">_</span> <span class="n">application</span><span class="p">:</span> <span class="bp">UIApplication</span><span class="p">,</span>
                     <span class="n">didFinishLaunchingWithOptions</span> <span class="n">launchOptions</span><span class="p">:</span>
                        <span class="p">[</span><span class="bp">UIApplication</span><span class="p">.</span><span class="n">LaunchOptionsKey</span><span class="p">:</span> <span class="nb">Any</span><span class="p">]?)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span> <span class="p">{</span>
        <span class="c1">// Override point for customization after application launch.</span>
        <span class="n">GADMobileAds</span><span class="p">.</span><span class="n">sharedInstance</span><span class="p">().</span><span class="n">start</span><span class="p">(</span><span class="n">completionHandler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h3 id="seleccion-del-formato-de-anuncio">Selección del formato de anuncio<a class="headerlink" href="#seleccion-del-formato-de-anuncio" title="Permanent link">&para;</a></h3>
<p>Tras importar e inicializar el SDK de anuncios para móviles, podemos
descargar un anuncio. AdMob ofrece diversos formatos de anuncios, y
debemos elegir uno de ellos, el que mejor se ajuste a la experiencia
de los usuarios de nuesra aplicación.</p>
<p>Dos de los más usados son de tipo <em>banner</em> y de tipo <em>interstiticial</em>.</p>
<p><strong>Banner</strong></p>
<p>Los anuncios de banner son anuncios rectangulares de imagen o de texto
que ocupan parte de la pantalla de una aplicación. Permanecen en
pantalla mientras los usuarios interactúan con la aplicación y pueden
actualizarse automáticamente después de un cierto periodo de
tiempo. Si es la primera vez que utilizamos la publicidad para móviles,
son un excelente punto de partida.</p>
<p>Existen distintos tamaños de banners, que podemos seleccionar con su
identificador:</p>
<table>
<thead>
<tr>
<th>Tamaño</th>
<th>Descripción</th>
<th>Disponibilidad</th>
<th>Identificador</th>
</tr>
</thead>
<tbody>
<tr>
<td>320x50</td>
<td>Banner</td>
<td>Teléfonos y tablets</td>
<td><code>kGADAdSizeBanner</code></td>
</tr>
<tr>
<td>320x100</td>
<td>Banner grande</td>
<td>Teléfonos y tablets</td>
<td><code>kGADAdSizeLargeBanner</code></td>
</tr>
<tr>
<td>300x250</td>
<td>Rectángulo mediano</td>
<td>Teléfonos y tablets</td>
<td><code>kGADAdSizeMediumRectangle</code></td>
</tr>
<tr>
<td>468x60</td>
<td>Banner de tamaño completo</td>
<td>Tablets</td>
<td><code>kGADAdSizeFullBanner</code></td>
</tr>
<tr>
<td>728x90</td>
<td>Leaderboard</td>
<td>Tablets</td>
<td><code>kGADAdSizeLeaderboard</code></td>
</tr>
</tbody>
</table>
<p><strong>Intersticial</strong></p>
<p>Los intersticiales son anuncios que ocupan toda la pantalla y cubren
la interfaz de una aplicación hasta que el usuario los cierra. El
mejor momento para usarlos son las pausas naturales de una
aplicación. Por ejemplo, al pasar de un nivel a otro en un juego o
después de completar una tarea.</p>
<p>Veamos el código para implementar un anuncio de cada uno de estos tipos.</p>
<h3 id="implementacion-de-un-banner">Implementación de un banner<a class="headerlink" href="#implementacion-de-un-banner" title="Permanent link">&para;</a></h3>
<p>Cuando probemos las aplicaciones debemos usar siempre anuncios de
prueba en lugar de anuncios reales. De lo contrario, Google podría
suspender nuestra cuenta de AdMob.</p>
<p>La forma más sencilla de cargar anuncios de prueba es mediante el ID
de bloque de anuncios de prueba que Google ha creado para banners de iOS:
<code>ca-app-pub-3940256099942544/2934735716</code>.</p>
<p>Cuando publiquemos la app sólo hay que sustituir este ID por el ID
real.</p>
<p>Los anuncios de banner se muestran en objetos <code>GADBannerView</code>, por lo
que lo primero que debemos hacer para integrarlos es incluir un objeto
<code>GADBannerView</code> en nuestra jerarquía de vistas.</p>
<p>Debemos actualizar las propiedades de este objeto:</p>
<ul>
<li><code>rootViewController</code>: controlador de vistas que se utiliza para
  mostrar una superposición cuando se hace clic en el anuncio. Como
  valor, normalmente se le da el controlador que contiene el 
  <code>GADBannerView</code>.</li>
<li><code>adUnitID</code>: el objeto GADBannerView debe cargar anuncios procedentes
  de este ID de bloque de anuncios.</li>
<li><code>delegate</code>: delegado que implementa el protocolo
  <code>GADBannerViewDelegate</code> que define las funciones en las que se
  reciben los eventos del ciclo de vida de los anuncios.</li>
</ul>
<p>Tras configurar el <code>GADBannerView</code> y sus propiedades podemos cargar un
anuncio. Para ello, se llama al método <code>loadRequest</code> pasando un objeto
<code>GADRequest</code>.</p>
<p>Por ejemplo, el siguiente código crea un objeto <code>GADBannerView</code> de
tamaño 320x50 e inicializa las propiedades anteriores:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">GoogleMobileAds</span>

<span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="bp">UIViewController</span><span class="p">,</span> <span class="n">GADBannerViewDelegate</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">bannerView</span><span class="p">:</span> <span class="n">GADBannerView</span><span class="p">!</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="n">bannerView</span> <span class="p">=</span> <span class="n">GADBannerView</span><span class="p">(</span><span class="n">adSize</span><span class="p">:</span> <span class="n">kGADAdSizeBanner</span><span class="p">)</span>
        <span class="n">bannerView</span><span class="p">.</span><span class="n">adUnitID</span> <span class="p">=</span> <span class="s">&quot;ca-app-pub-3940256099942544/2934735716&quot;</span>
        <span class="n">bannerView</span><span class="p">.</span><span class="n">rootViewController</span> <span class="p">=</span> <span class="kc">self</span>
        <span class="n">bannerView</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">GADRequest</span><span class="p">())</span>
        <span class="n">bannerView</span><span class="p">.</span><span class="n">delegate</span> <span class="p">=</span> <span class="kc">self</span>
    <span class="p">}</span>

    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>En el siguiente método <code>addBannerViewToView(_:)</code> se añade la vista del
anuncio, alineándose con la parte inferior del área segura de
pantalla:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">addBannerViewToView</span><span class="p">(</span><span class="kc">_</span> <span class="n">bannerView</span><span class="p">:</span> <span class="n">GADBannerView</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">bannerView</span><span class="p">.</span><span class="n">translatesAutoresizingMaskIntoConstraints</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="n">view</span><span class="p">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">bannerView</span><span class="p">)</span>
    <span class="n">view</span><span class="p">.</span><span class="n">addConstraints</span><span class="p">(</span>
      <span class="p">[</span><span class="bp">NSLayoutConstraint</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">bannerView</span><span class="p">,</span>
                          <span class="n">attribute</span><span class="p">:</span> <span class="p">.</span><span class="n">bottom</span><span class="p">,</span>
                          <span class="n">relatedBy</span><span class="p">:</span> <span class="p">.</span><span class="bp">equal</span><span class="p">,</span>
                          <span class="n">toItem</span><span class="p">:</span> <span class="n">bottomLayoutGuide</span><span class="p">,</span>
                          <span class="n">attribute</span><span class="p">:</span> <span class="p">.</span><span class="n">top</span><span class="p">,</span>
                          <span class="n">multiplier</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                          <span class="n">constant</span><span class="p">:</span> <span class="mi">0</span><span class="p">),</span>
       <span class="bp">NSLayoutConstraint</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">bannerView</span><span class="p">,</span>
                          <span class="n">attribute</span><span class="p">:</span> <span class="p">.</span><span class="n">centerX</span><span class="p">,</span>
                          <span class="n">relatedBy</span><span class="p">:</span> <span class="p">.</span><span class="bp">equal</span><span class="p">,</span>
                          <span class="n">toItem</span><span class="p">:</span> <span class="n">view</span><span class="p">,</span>
                          <span class="n">attribute</span><span class="p">:</span> <span class="p">.</span><span class="n">centerX</span><span class="p">,</span>
                          <span class="n">multiplier</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                          <span class="n">constant</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">])</span>
   <span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Por último, es recomendable realizar la llamada a la función anterior
que incorpora el <code>GADBannerView</code> a la jerarquía de vistas después de
haber recibido un anuncio. Para ello, se usa la función del delegado
<code>adViewDidReceiveAd</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="c1">/// Tells the delegate an ad request loaded an ad.</span>
    <span class="kd">func</span> <span class="nf">adViewDidReceiveAd</span><span class="p">(</span><span class="kc">_</span> <span class="n">bannerView</span><span class="p">:</span> <span class="n">GADBannerView</span><span class="p">)</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;adViewDidReceiveAd&quot;</span><span class="p">)</span>
        <span class="n">addBannerViewToView</span><span class="p">(</span><span class="n">bannerView</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Podemos implementar el resto de funciones del delegado, con sentencias
<code>print</code> para depurar cuando se produce cada evento:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="c1">/// Tells the delegate an ad request failed.</span>
    <span class="kd">func</span> <span class="nf">adView</span><span class="p">(</span><span class="kc">_</span> <span class="n">bannerView</span><span class="p">:</span> <span class="n">GADBannerView</span><span class="p">,</span>
                <span class="n">didFailToReceiveAdWithError</span> <span class="n">error</span><span class="p">:</span> <span class="n">GADRequestError</span><span class="p">)</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;adView:didFailToReceiveAdWithError: </span><span class="si">\(</span><span class="n">error</span><span class="p">.</span><span class="n">localizedDescription</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">/// Tells the delegate that a full-screen view will be presented in response</span>
    <span class="c1">/// to the user clicking on an ad.</span>
    <span class="kd">func</span> <span class="nf">adViewWillPresentScreen</span><span class="p">(</span><span class="kc">_</span> <span class="n">bannerView</span><span class="p">:</span> <span class="n">GADBannerView</span><span class="p">)</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;adViewWillPresentScreen&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">/// Tells the delegate that the full-screen view will be dismissed.</span>
    <span class="kd">func</span> <span class="nf">adViewWillDismissScreen</span><span class="p">(</span><span class="kc">_</span> <span class="n">bannerView</span><span class="p">:</span> <span class="n">GADBannerView</span><span class="p">)</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;adViewWillDismissScreen&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">/// Tells the delegate that the full-screen view has been dismissed.</span>
    <span class="kd">func</span> <span class="nf">adViewDidDismissScreen</span><span class="p">(</span><span class="kc">_</span> <span class="n">bannerView</span><span class="p">:</span> <span class="n">GADBannerView</span><span class="p">)</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;adViewDidDismissScreen&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">/// Tells the delegate that a user click will open another app (such as</span>
    <span class="c1">/// the App Store), backgrounding the current app.</span>
    <span class="kd">func</span> <span class="nf">adViewWillLeaveApplication</span><span class="p">(</span><span class="kc">_</span> <span class="n">bannerView</span><span class="p">:</span> <span class="n">GADBannerView</span><span class="p">)</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;adViewWillLeaveApplication&quot;</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table>

<h3 id="implementacion-de-un-interstitial">Implementación de un interstitial<a class="headerlink" href="#implementacion-de-un-interstitial" title="Permanent link">&para;</a></h3>
<p>Los anuncios intersticiales los solicitan y muestran los objetos
<code>GADInterstitial</code>. </p>
<p>Debemos crear una instancia y asignar el ID de su bloque de anuncios.
Podemos cargar anuncios de prueba de tipo <em>Interstitial</em> usando el ID
<code>ca-app-pub-3940256099942544/4411468910</code>.</p>
<p>Por ejemplo, aquí se muestra cómo crear un <code>GADInterstitial</code> en el
método <code>viewDidLoad</code> de un <code>UIViewController</code>. Hacemos también que el
<em>interstitial</em> lance una petición para cargar una anuncio, y definimos
como delegado el <em>view controller</em>. Para ello el <em>view controller</em>
debe cumplir el protocolo <code>GADInterstitialDelegate</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">GoogleMobileAds</span>

<span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="bp">UIViewController</span><span class="p">,</span> <span class="n">GADInterstitialDelegate</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">interstitial</span><span class="p">:</span> <span class="n">GADInterstitial</span><span class="p">!</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="c1">// Do any additional setup after loading the view.</span>
        <span class="n">interstitial</span> <span class="p">=</span> <span class="n">GADInterstitial</span><span class="p">(</span><span class="n">adUnitID</span><span class="p">:</span> <span class="s">&quot;ca-app-pub-3940256099942544/4411468910&quot;</span><span class="p">)</span>
        <span class="n">interstitial</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">GADRequest</span><span class="p">())</span>
        <span class="n">interstitial</span><span class="p">.</span><span class="n">delegate</span> <span class="p">=</span> <span class="kc">self</span>
    <span class="p">}</span>

    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p><code>GADInterstitial</code> es un objeto de un solo uso que, al cargarse, muestra
un anuncio intersticial. Para que una aplicación muestre varios
anuncios intersticiales, es necesario crear un <code>GADInterstitial</code> para
cada uno de ellos (lo veremos más adelante).</p>
<p>Para mostrar un intersticial, podemos verificar la propiedad <code>isReady</code> en
<code>GADInterstitial</code> para asegurarnos de que ha terminado de cargarse y,
después, debemos llamar a <code>presentFromRootViewController</code> pasándole el
<em>view controller</em> actual como <em>view controller</em> raíz:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="p">...</span>
  <span class="k">if</span> <span class="n">interstitial</span><span class="p">.</span><span class="n">isReady</span> <span class="p">{</span>
    <span class="n">interstitial</span><span class="p">.</span><span class="n">present</span><span class="p">(</span><span class="n">fromRootViewController</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;El anuncio no está disponible&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Al igual que hacíamos en el <em>banner</em> podemos realizar esta llamada en
la función del delegado <code>interstitialDidReceiveAd</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="c1">/// Tells the delegate an ad request succeeded.</span>
    <span class="kd">func</span> <span class="nf">interstitialDidReceiveAd</span><span class="p">(</span><span class="kc">_</span> <span class="n">ad</span><span class="p">:</span> <span class="n">GADInterstitial</span><span class="p">)</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;interstitialDidReceiveAd&quot;</span><span class="p">)</span>
        <span class="n">interstitial</span><span class="p">.</span><span class="n">present</span><span class="p">(</span><span class="n">fromRootViewController</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table>

<p>El resto de funciones del delegado son las siguientes:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">/// Tells the delegate an ad request failed.</span>
<span class="kd">func</span> <span class="nf">interstitial</span><span class="p">(</span><span class="kc">_</span> <span class="n">ad</span><span class="p">:</span> <span class="n">GADInterstitial</span><span class="p">,</span> <span class="n">didFailToReceiveAdWithError</span> <span class="n">error</span><span class="p">:</span> <span class="n">GADRequestError</span><span class="p">)</span> <span class="p">{</span>
  <span class="bp">print</span><span class="p">(</span><span class="s">&quot;interstitial:didFailToReceiveAdWithError: </span><span class="si">\(</span><span class="n">error</span><span class="p">.</span><span class="n">localizedDescription</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">/// Tells the delegate that an interstitial will be presented.</span>
<span class="kd">func</span> <span class="nf">interstitialWillPresentScreen</span><span class="p">(</span><span class="kc">_</span> <span class="n">ad</span><span class="p">:</span> <span class="n">GADInterstitial</span><span class="p">)</span> <span class="p">{</span>
  <span class="bp">print</span><span class="p">(</span><span class="s">&quot;interstitialWillPresentScreen&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">/// Tells the delegate the interstitial is to be animated off the screen.</span>
<span class="kd">func</span> <span class="nf">interstitialWillDismissScreen</span><span class="p">(</span><span class="kc">_</span> <span class="n">ad</span><span class="p">:</span> <span class="n">GADInterstitial</span><span class="p">)</span> <span class="p">{</span>
  <span class="bp">print</span><span class="p">(</span><span class="s">&quot;interstitialWillDismissScreen&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">/// Tells the delegate the interstitial had been animated off the screen.</span>
<span class="kd">func</span> <span class="nf">interstitialDidDismissScreen</span><span class="p">(</span><span class="kc">_</span> <span class="n">ad</span><span class="p">:</span> <span class="n">GADInterstitial</span><span class="p">)</span> <span class="p">{</span>
  <span class="bp">print</span><span class="p">(</span><span class="s">&quot;interstitialDidDismissScreen&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">/// Tells the delegate that a user click will open another app</span>
<span class="c1">/// (such as the App Store), backgrounding the current app.</span>
<span class="kd">func</span> <span class="nf">interstitialWillLeaveApplication</span><span class="p">(</span><span class="kc">_</span> <span class="n">ad</span><span class="p">:</span> <span class="n">GADInterstitial</span><span class="p">)</span> <span class="p">{</span>
  <span class="bp">print</span><span class="p">(</span><span class="s">&quot;interstitialWillLeaveApplication&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Tal y como hemos comentado el <code>GADInterstitial</code> es un objeto de un
solo uso. Eso significa que una vez que se muestra un intersticial,
<code>hasBeenUsed</code> devuelve el valor <code>true</code> y el intersticial no se puede usar
para cargar otro anuncio. </p>
<p>Para solicitar otro, deberemos crear un nuevo objeto
<code>GADInterstitial</code>. Si intentamos reutilizar un objeto intersticial,
aparecerá el mensaje <code>"Request Error: Will not send request because
interstitial object has been used"</code></p>
<p>El mejor lugar para asignar otro intersticial es en el método
<code>interstitialDidDismissScreen</code> del delegado <code>GADInterstitialDelegate</code>,
para que el siguiente intersticial comience a cargarse tan pronto como
se cierre el anterior.</p>
<p>Podemos refactorizar la creación del interstiticial en una función
aparte, y llamar a esa función desde <code>viewDidLoad</code> y desde
<code>interstitialDidDismissScreen</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
  <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
  <span class="n">interstitial</span> <span class="p">=</span> <span class="n">createAndLoadInterstitial</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">createAndLoadInterstitial</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">GADInterstitial</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nv">interstitial</span> <span class="p">=</span> <span class="n">GADInterstitial</span><span class="p">(</span><span class="n">adUnitID</span><span class="p">:</span> <span class="s">&quot;ca-app-pub-3940256099942544/4411468910&quot;</span><span class="p">)</span>
  <span class="n">interstitial</span><span class="p">.</span><span class="n">delegate</span> <span class="p">=</span> <span class="kc">self</span>
  <span class="n">interstitial</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">GADRequest</span><span class="p">())</span>
  <span class="k">return</span> <span class="n">interstitial</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">interstitialDidDismissScreen</span><span class="p">(</span><span class="kc">_</span> <span class="n">ad</span><span class="p">:</span> <span class="n">GADInterstitial</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">interstitial</span> <span class="p">=</span> <span class="n">createAndLoadInterstitial</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h2 id="demo-aplicacion-de-prueba">Demo: Aplicación de prueba<a class="headerlink" href="#demo-aplicacion-de-prueba" title="Permanent link">&para;</a></h2>
<p>Puedes descargarte una <a href="https://github.com/domingogallardo/apuntes-spm-ios/raw/master/apps/PruebaAds.zip">aplicación de
prueba</a>
en la que se muestra el funcionamiento básico de AdMob.</p>
<p style="text-align:center;">
<img style="border: 1px solid;" src="imagenes/pruebaAds-1.png" width="200px"/>
<img style="margin-left:30px" src="imagenes/pruebaAds-2.png" width="200px"/>
</p>

<p>Se debe ejecutar la app en un dispositivo real, ya que AdMob no
funciona en el simulador. También debes darte de alta en AdMob, registrar
una aplicación e incluir el número de registro en el fichero <code>Info.plist</code>.</p>
<h2 id="compras-in-app">Compras In-App<a class="headerlink" href="#compras-in-app" title="Permanent link">&para;</a></h2>
<h3 id="que-es-una-compra-in-app">¿Qué es una compra In-App?<a class="headerlink" href="#que-es-una-compra-in-app" title="Permanent link">&para;</a></h3>
<p>Permite vender directamente una funcionalidad dentro de una app.</p>
<p>Los datos de la compra (precio, identificador) se definen en iTunes Connect.</p>
<p>Se implementa con el API StoreKit:</p>
<ul>
<li>StoreKit pregunta al usuario si confirma la transacción a través del
  acceso seguro del App Store.</li>
<li>La app recibe la confirmación de la compra y debe desbloquear
  dinámicamente la funcionalidad.</li>
<li>La app debe guardar la información de que el usuario ha comprado esa
  nueva funcionalidad, aunque el usuario siempre puede recuperar la
  compra.</li>
</ul>
<p style="text-align:center;">
<img src="imagenes/in-app-storekit.png" width="600px"/>
</p>

<h3 id="ejemplos-de-uso">Ejemplos de uso<a class="headerlink" href="#ejemplos-de-uso" title="Permanent link">&para;</a></h3>
<p>Las compras In-App son una de las formas de monetización más usadas
en la actualidad</p>
<p>Por ejemplo:</p>
<ul>
<li>Podemos dar una versión básica gratuita y vender funcionalidades
  adicionales premium.</li>
<li>Podemos permitir la suscripción a contenidos periódicos que se pueden descargar<ul>
<li>Ofertas de niveles adicionales en juegos</li>
<li>Compras de mercancías virtuales en juegos on-line</li>
</ul>
</li>
</ul>
<h3 id="tipos-de-compras-in-app-compras">Tipos de compras In-App - Compras<a class="headerlink" href="#tipos-de-compras-in-app-compras" title="Permanent link">&para;</a></h3>
<ul>
<li>No-consumibles<ul>
<li>Ítems que permanecen disponibles de forma indefinida en todos los dispositivos del usuario.</li>
<li>Ejemplos: libros, niveles de un juego, funcionalidades premium de un app.</li>
</ul>
</li>
<li>Consumibles<ul>
<li>Ítems que se consumen durante el tipo de ejecución del app.</li>
<li>Ejemplos: minutos de llamadas de voz sobre IP, o servicios de un sólo uso como transcripción de voz.</li>
</ul>
</li>
</ul>
<h3 id="tipos-de-compras-in-app-suscripciones">Tipos de compras In-App - Suscripciones<a class="headerlink" href="#tipos-de-compras-in-app-suscripciones" title="Permanent link">&para;</a></h3>
<ul>
<li>Suscripciones auto-renovables<ul>
<li>Como los no-consumibles, las suscripciones permanecen
  disponibles en todos los dispositivos. Tienen una fecha de
  expiración, en la que el sistema renueva automáticamente la
  compra.</li>
</ul>
</li>
<li>Suscripciones no-renovables<ul>
<li>Suscripciones en las que no se entrega contenido periódico.</li>
<li>Ejemplos: acceso a una base de datos de fotos históricas.</li>
<li>Suele acompañarse de una cuenta de usuario en un servidor.</li>
<li>La duración y la expiración de la suscripción se realizan desde
  la app (y el servidor).</li>
</ul>
</li>
</ul>
<h3 id="requisitos-para-activar-las-in-app">Requisitos para activar las In-App<a class="headerlink" href="#requisitos-para-activar-las-in-app" title="Permanent link">&para;</a></h3>
<p>Las compras In-App sólo pueden probarse y activarse con una cuenta
de desarrollador de pago.</p>
<p>Es necesario acceso a iTunes Connect para configurar las compras.</p>
<p>No es posible hacerlo con el equipo de la universidad.</p>
<p>Haremos una demo con una cuenta de desarrollador.</p>
<h3 id="contratos">Contratos<a class="headerlink" href="#contratos" title="Permanent link">&para;</a></h3>
<p><strong>¡Cuidado!</strong>: Para poder probar las compras In-App hay que tener
todos los contratos en regla.</p>
<p style="text-align:center;">
<img src="imagenes/in-app-contratos.png" width="800px"/>
</p>

<h3 id="servicios-a-activar-en-la-app">Servicios a activar en la app<a class="headerlink" href="#servicios-a-activar-en-la-app" title="Permanent link">&para;</a></h3>
<p style="text-align:center;">
<img style="border: 1px solid;" src="imagenes/in-app-capabilities.png" width="700px"/>
</p>

<h3 id="bundle-identifier-y-app-id"><em>Bundle identifier</em> y App Id<a class="headerlink" href="#bundle-identifier-y-app-id" title="Permanent link">&para;</a></h3>
<p style="text-align:center;">
<img src="imagenes/in-app-bundle-name.png" width="400px"/>
<img src="imagenes/in-app-app-id.png" width="600px"/>
</p>

<h3 id="configuracion-in-app-desde-itunes-connect">Configuración In-App desde iTunes Connect<a class="headerlink" href="#configuracion-in-app-desde-itunes-connect" title="Permanent link">&para;</a></h3>
<p style="text-align:center;">
<img src="imagenes/in-app-itunes-connect.png" width="700px"/>
</p>

<h3 id="datos-del-app">Datos del app<a class="headerlink" href="#datos-del-app" title="Permanent link">&para;</a></h3>
<p style="text-align:center;">
<img style="border: 1px solid;" src="imagenes/app-itunes-connect.png" width="800px"/>
</p>

<h3 id="pantalla-para-anadir-nuevos-in-apps">Pantalla para añadir nuevos In-Apps<a class="headerlink" href="#pantalla-para-anadir-nuevos-in-apps" title="Permanent link">&para;</a></h3>
<p style="text-align:center;">
<img style="border: 1px solid;" src="imagenes/producto-in-app.png" width="900px"/>
</p>

<h3 id="seleccionar-el-tipo-de-in-app">Seleccionar el tipo de In-App<a class="headerlink" href="#seleccionar-el-tipo-de-in-app" title="Permanent link">&para;</a></h3>
<p style="text-align:center;">
<img style="border: 1px solid;" src="imagenes/in-app-tipo.png" width="700px"/>
</p>

<h3 id="caracteristicas-del-in-app">Características del In-App<a class="headerlink" href="#caracteristicas-del-in-app" title="Permanent link">&para;</a></h3>
<ul>
<li>Nombre de referencia: aparece en la ventana de compra</li>
<li>ID del producto: identificador del In-App para reconocerlo en el app</li>
<li>Precio</li>
<li>Datos para la revisión de Apple</li>
</ul>
<h3 id="caracteristicas-del-in-app_1">Características del In-App<a class="headerlink" href="#caracteristicas-del-in-app_1" title="Permanent link">&para;</a></h3>
<p style="text-align:center;">
<img src="imagenes/ejemplo-in-app.png" width="700px"/>
</p>

<p style="text-align:center;">
<img src="imagenes/ejemplo-in-app-2.png" width="700px"/>
</p>

<h3 id="usuarios-de-prueba">Usuarios de prueba<a class="headerlink" href="#usuarios-de-prueba" title="Permanent link">&para;</a></h3>
<p>Para probar las compras In-App debemos crear usuarios de prueba de
sandbox en iTunes Connect.</p>
<p>En el dispositivo de prueba hay que iniciar la sesión en el App Store
con ese usuario de prueba.</p>
<p style="text-align:center;">
<img style="border: 1px solid;" src="imagenes/in-app-usuario-prueba.png" width="700px"/> 
</p>

<p style="text-align:center;">
<img style="border: 1px solid;" src="imagenes/in-app-app-store.jpg" width="200px"/>
<img style="border: 1px solid;" src="imagenes/in-app-app-store-2.png" width="200px"/>
</p>

<h2 id="demo">Demo<a class="headerlink" href="#demo" title="Permanent link">&para;</a></h2>
<p>Vamos a ver un ejemplo de aplicación que contiene una pantalla
sorpresa cuyo acceso se activa con una compra In-App.</p>
<p>Está disponible en <a href="https://github.com/domingogallardo/apuntes-spm-ios/raw/master/apps/EjemploInApp.zip">este
enlace</a></p>
<p style="text-align:center;">
<img style="border: 1px solid;" src="imagenes/in-app-prueba-1.jpg" width="170px"/>
<img class="fragment" style="border: 1px solid;" src="imagenes/in-app-prueba-2.jpg" width="170px"/>
<img class="fragment" style="border: 1px solid;" src="imagenes/in-app-prueba-3.jpg" width="170px"/>
</p>

<p style="text-align:center;">
<img class="fragment" style="border: 1px solid;" src="imagenes/in-app-prueba-4.jpg" width="170px"/>
<img class="fragment" style="border: 1px solid;" src="imagenes/in-app-prueba-5.jpg" width="170px"/>
<img style="border: 1px solid;" src="imagenes/in-app-prueba-6.jpg" width="170px"/>
</p>

<h2 id="codigo-para-implementar-las-compras-in-app">Código para implementar las compras In-App<a class="headerlink" href="#codigo-para-implementar-las-compras-in-app" title="Permanent link">&para;</a></h2>
<h3 id="el-proceso-de-compra-en-un-vistazo">El proceso de compra en un vistazo<a class="headerlink" href="#el-proceso-de-compra-en-un-vistazo" title="Permanent link">&para;</a></h3>
<p>Debemos implementar los protocolos
<a href="https://developer.apple.com/library/ios/documentation/StoreKit/Reference/SKProductsRequestDelegate/"><code>SKProductsRequestDelegate</code></a>
y
<a href="https://developer.apple.com/library/ios/documentation/StoreKit/Reference/SKPaymentTransactionObserver_Protocol/"><code>SKPaymentTransactionObserver</code></a>.</p>
<p style="text-align:center;">
<img src="imagenes/in-app-vistazo.png" width="700px"/>
</p>

<h3 id="clase-auxiliar-inapp">Clase auxiliar InApp<a class="headerlink" href="#clase-auxiliar-inapp" title="Permanent link">&para;</a></h3>
<p>Creamos un protocolo <code>InAppDelegate</code> y una clase <code>InApp</code> donde
gestionaremos la interacción con <code>StoreKit</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">protocol</span> <span class="nc">InAppDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">compraRecibida</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">InApp</span><span class="p">:</span> <span class="bp">NSObject</span><span class="p">,</span> <span class="bp">SKProductsRequestDelegate</span><span class="p">,</span> <span class="bp">SKPaymentTransactionObserver</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">productDetailsList</span><span class="p">:</span> <span class="p">[</span><span class="bp">SKProduct</span><span class="p">]</span> <span class="p">=</span> <span class="p">[]</span>
    <span class="kd">var</span> <span class="nv">productIdentiferList</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">]</span> <span class="p">=</span> <span class="p">[]</span>
    <span class="kd">var</span> <span class="nv">delegate</span><span class="p">:</span> <span class="n">InAppDelegate</span><span class="p">?</span>

    <span class="kr">override</span> <span class="kd">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="kd">init</span><span class="p">()</span>
        <span class="bp">SKPaymentQueue</span><span class="p">.</span><span class="n">defaultQueue</span><span class="p">().</span><span class="n">addTransactionObserver</span><span class="p">(</span><span class="kc">self</span><span class="p">)</span>
        <span class="c1">// Cargamos la lista de productos</span>
        <span class="n">productIdentiferList</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;ejemplo3&quot;</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nv">request</span> <span class="p">=</span> <span class="bp">SKProductsRequest</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">productIdentifiers</span><span class="p">:</span> 
                            <span class="n">Set</span><span class="p">(</span><span class="n">productIdentiferList</span><span class="p">))</span>
        <span class="n">request</span><span class="p">.</span><span class="n">delegate</span> <span class="p">=</span> <span class="kc">self</span>
        <span class="n">request</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    <span class="p">}</span>


<span class="c1">// Método del delegado al que se llama cuando se han recibido los productos</span>

<span class="kd">func</span> <span class="nf">productsRequest</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="bp">SKProductsRequest</span><span class="p">,</span> <span class="n">didReceiveResponse</span> <span class="n">response</span><span class="p">:</span> <span class="bp">SKProductsResponse</span><span class="p">)</span> <span class="p">{</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Hemos recibido </span><span class="si">\(</span><span class="n">response</span><span class="p">.</span><span class="n">products</span><span class="p">.</span><span class="bp">count</span><span class="si">)</span><span class="s"> productos&quot;</span><span class="p">)</span>
    <span class="n">productDetailsList</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">products</span>
    <span class="k">for</span> <span class="n">invalidProductId</span> <span class="k">in</span> <span class="n">response</span><span class="p">.</span><span class="n">invalidProductIdentifiers</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Producto invalido id: </span><span class="si">\(</span><span class="n">invalidProductId</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Método para lanzar la petición de compra al usuario</span>

<span class="kd">func</span> <span class="nf">lanzarPago</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="kc">self</span><span class="p">.</span><span class="n">productDetailsList</span><span class="p">.</span><span class="bp">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
              <span class="bp">SKPaymentQueue</span><span class="p">.</span><span class="n">canMakePayments</span><span class="p">())</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">producto</span> <span class="p">=</span> <span class="n">productDetailsList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="kd">let</span> <span class="nv">pago</span> <span class="p">=</span> <span class="bp">SKPayment</span><span class="p">(</span><span class="n">product</span><span class="p">:</span> <span class="n">producto</span><span class="p">)</span>
        <span class="bp">SKPaymentQueue</span><span class="p">.</span><span class="n">defaultQueue</span><span class="p">().</span><span class="n">addPayment</span><span class="p">(</span><span class="n">pago</span><span class="p">)</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Comprando...&quot;</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;No existen productos&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Método del delegado al que se llama cuando el usuario compra el InApp</span>
<span class="kd">func</span> <span class="nf">paymentQueue</span><span class="p">(</span><span class="n">queue</span><span class="p">:</span> <span class="bp">SKPaymentQueue</span><span class="p">,</span> 
                  <span class="n">updatedTransactions</span> <span class="n">transactions</span><span class="p">:</span> 
                                    <span class="p">[</span><span class="bp">SKPaymentTransaction</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">transaction</span> <span class="k">in</span> <span class="n">transactions</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="n">transaction</span><span class="p">.</span><span class="n">transactionState</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">Purchased</span><span class="p">:</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Purchased&quot;</span><span class="p">)</span>
            <span class="n">delegate</span><span class="p">?.</span><span class="n">compraRecibida</span><span class="p">()</span>
            <span class="bp">SKPaymentQueue</span><span class="p">.</span><span class="n">defaultQueue</span><span class="p">()</span>
                            <span class="p">.</span><span class="n">finishTransaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">Failed</span><span class="p">:</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Failed&quot;</span><span class="p">)</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Error de transacción: </span><span class="si">\(</span><span class="n">transaction</span><span class="p">.</span><span class="n">error</span><span class="p">?.</span><span class="n">localizedDescription</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">SKPaymentQueue</span><span class="p">.</span><span class="n">defaultQueue</span><span class="p">()</span>
                            <span class="p">.</span><span class="n">finishTransaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">Restored</span><span class="p">:</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Restored&quot;</span><span class="p">)</span>
            <span class="n">delegate</span><span class="p">?.</span><span class="n">compraRecibida</span><span class="p">()</span>
            <span class="bp">SKPaymentQueue</span><span class="p">.</span><span class="n">defaultQueue</span><span class="p">()</span>
                           <span class="p">.</span><span class="n">finishTransaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
        <span class="k">default</span><span class="p">:</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Otro&quot;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h3 id="clase-viewcontroller">Clase ViewController<a class="headerlink" href="#clase-viewcontroller" title="Permanent link">&para;</a></h3>
<p>En la clase <code>ViewController</code> adoptamos nuestro protocolo
<code>InAppDelegate</code> y definimos su método <code>compraRecibida()</code> al que se va
a llamar cuando se haya recibido y validado la compra.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="bp">UIViewController</span><span class="p">,</span> <span class="n">InAppDelegate</span> <span class="p">{</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">botonSorpresa</span><span class="p">:</span> <span class="bp">UIButton</span><span class="p">!</span>
    <span class="kd">let</span> <span class="nv">inApp</span> <span class="p">=</span> <span class="n">InApp</span><span class="p">()</span> <span class="c1">// Instancia de la clase auxiliar InApp</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Nos hacemos delegados de InApp</span>
        <span class="n">inApp</span><span class="p">.</span><span class="n">delegate</span> <span class="p">=</span> <span class="kc">self</span>

        <span class="c1">// Escondemos el botón que da acceso a la pantalla sorpresa</span>
        <span class="n">botonSorpresa</span><span class="p">.</span><span class="n">hidden</span> <span class="p">=</span> <span class="kc">true</span>

        <span class="c1">// Comprobamos si el usuario ha comprado antes el inApp</span>
        <span class="c1">// Funciona si el usuario está identificado </span>
        <span class="k">if</span> <span class="bp">NSUserDefaults</span><span class="p">.</span><span class="n">standardUserDefaults</span><span class="p">().</span><span class="n">boolForKey</span><span class="p">(</span><span class="s">&quot;inAppComprado&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">botonSorpresa</span><span class="p">.</span><span class="n">hidden</span> <span class="p">=</span> <span class="kc">false</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">botonSorpresa</span><span class="p">.</span><span class="n">hidden</span> <span class="p">=</span> <span class="kc">true</span>
        <span class="p">}</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table>

<p>La acción asociada al botón de compra llama al método <code>lanzarPago</code> de
la instancia de nuestra clase <code>InApp</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="c1">// Acción asociada al botón de compra</span>
    <span class="kr">@IBAction</span> <span class="kd">func</span> <span class="nf">hazCompra</span><span class="p">(</span><span class="n">sender</span><span class="p">:</span> <span class="bp">UIButton</span><span class="p">)</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Click botón de compra&quot;</span><span class="p">)</span>
        <span class="n">inApp</span><span class="p">.</span><span class="n">lanzarPago</span><span class="p">()</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table>

<p>En el método <code>compraRecibida()</code> (del protocolo) activamos un botón que
da acceso a la pantalla sorpresa.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="c1">// Implementación del método del protocolo InAppDelegate</span>
    <span class="kd">func</span> <span class="nf">compraRecibida</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">botonSorpresa</span><span class="p">.</span><span class="n">hidden</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Acción para mostrar la pantalla sorpresa:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="kr">@IBAction</span> <span class="kd">func</span> <span class="nf">sorpresa</span><span class="p">(</span><span class="n">sender</span><span class="p">:</span> <span class="bp">UIButton</span><span class="p">){</span>
        <span class="n">performSegueWithIdentifier</span><span class="p">(</span><span class="s">&quot;Sorpresa&quot;</span><span class="p">,</span> <span class="n">sender</span><span class="p">:</span> <span class="n">view</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h2 id="practica">Práctica<a class="headerlink" href="#practica" title="Permanent link">&para;</a></h2>
<p>En la práctica deberás añadir anuncios a la app <code>ToDoList</code>.</p>
<ul>
<li>Debes añadir un banner en la parte inferior de la lista de tareas. </li>
<li>El anuncio del banner debe cambiar cada vez que se vuelve a esta
  lista desde la pantalla con el resumen de tareas completadas.</li>
<li>Una de cada cinco veces que se vuelva a esta lista de tareas debe
  mostrarse un anuncio intersticial.</li>
<li>En la pantalla del resumen de tareas completadas debes poner un
  botón que abra una alerta para quitar los anuncios. Una vez que el
  usuario lo confirme dejarán de mostrarse anuncios en la app
  (simulando una compra InApp).</li>
</ul>
<h2 id="referencias">Referencias<a class="headerlink" href="#referencias" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://developers.google.com/admob/ios/quick-start">Google AdMob SDK para iOS</a></li>
<li><a href="https://developer.apple.com/in-app-purchase/">Recursos sobre compras In-App</a></li>
<li><a href="https://help.apple.com/app-store-connect/#/devb57be10e7">App Store Connect - In-App purchase</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/StoreKitGuide/Introduction.html">In-App Purchase Programming Guide</a></li>
<li><a href="https://developer.apple.com/library/ios/releasenotes/General/ValidateAppStoreReceipt/Introduction.html#//apple_ref/doc/uid/TP40010573-CH105-SW1">Receipt Validation Programming Guide</a></li>
<li><a href="https://developer.apple.com/library/mac/documentation/StoreKit/Reference/StoreKit_Collection/">StoreKit Framework Reference</a></li>
<li><a href="https://developer.apple.com/library/ios/technotes/tn2259/_index.html#//apple_ref/doc/uid/DTS40009578">Technical Note: Adding In-App Purchase to your iOS and OS X Applications</a></li>
<li><a href="https://developer.apple.com/library/ios/technotes/tn2387/_index.html">Technical Note: In-App Purchase Best Practices</a></li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../sesion05/sesion05-extensiones.html" title="Sesión 5 - Extensiones" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Anterior
                </span>
                Sesión 5 - Extensiones
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.dc02f8ce.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>